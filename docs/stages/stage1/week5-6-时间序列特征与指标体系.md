# 阶段1 第5-6周理论学习笔记：时间序列特征、指标体系与交易成本

> 面向：数学基础≈初中、会一点 Python 的量化开发入门者。
> 目标：用“能看懂图表和代码注释”的语言，建立时间序列波动、技术指标和交易成本的直觉。

---

## 一、第5周：时间序列特征与波动结构

### 1. 滚动统计量：在时间轴上滑动的“放大镜”

#### 1.1 数学思想
- 有一条时间序列（比如每日收益率 `r_t`）。
- 不是一次性看全局，而是在每个时间点，向前看固定天数 N 天的数据。
- 对“最近 N 天”的数据求：
  - **滚动均值**：这一段时间的平均水平；
  - **滚动标准差**：这一段时间的典型波动大小（离散程度）。
- 这样得到两条新序列：`rolling_mean_t` 和 `rolling_std_t`，随时间移动。

#### 1.2 直观理解
- 把“放大镜”在 K 线上往前推，每次放大固定长度的一小段：
  - 均值：这段时间整体是涨多还是跌多；
  - 标准差：这段时间“抖动”大不大。
- 标准差越大，说明最近行情很“暴躁”；越小说明最近很“平静”。

#### 1.3 对交易的意义
- **市场状态检测**：用滚动标准差可以知道当下处在高波动期还是低波动期。
- **风控参数**：高波动期可以考虑：
  - 降低杠杆或仓位；
  - 调整止损/止盈距离。
- **策略适配**：一些策略（比如趋势跟随）可能更适合高波动期，另一些（比如区间震荡）可能更适合低波动期。

---

### 2. 自相关与滚动自相关：当前是否“记得”过去

#### 2.1 数学思想
- **相关性**：两个变量一起涨一起跌的程度。
- **自相关（ACF）**：同一条时间序列，与它自己“错开几天”的版本之间的相关性。
  - 比如 `r_t` 与 `r_{t-1}` 的相关性，就是滞后1期的自相关（lag=1）。
- **滚动自相关**：不在全历史上算一次，而是在“最近 N 天”这个窗口里，反复计算自相关。

#### 2.2 直观理解
- 如果 lag=1 自相关为正：
  - 最近“涨了就更容易继续涨、跌了就更容易继续跌”，有一点趋势味道；
- 如果为负：
  - 最近“涨多了容易回调、跌多了容易反弹”，有一点均值回归（震荡）味道。
- 做滚动自相关，就是看这种“趋势/震荡”的倾向，随时间是否在变化。

#### 2.3 对交易的意义
- **短期可预测性**：自相关不是“能不能预测”的绝对答案，但能提示：
  - 当前更像趋势市还是震荡市。
- **策略选择**：
  - 自相关偏正：可以更偏趋势跟随；
  - 自相关偏负：可以考虑均值回归类策略。
- **状态切分**：根据滚动自相关和滚动波动率，把历史分成几种“市场状态”，后续可以研究不同状态下策略表现差异。

---

### 3. 波动聚类与极端行情：风险不会平均分布

#### 3.1 数学思想
- **波动聚类**：时间序列中，
  - 大波动的日子喜欢扎堆在一起；
  - 小波动的日子也喜欢扎堆在一起。
- 不是“每天的波动都差不多”，而是有明显的高波动期/低波动期区间。
- **极端行情**：收益率绝对值超过某个阈值（比如 3% 或 5%）的日子，属于“极端波动日”。

#### 3.2 直观理解
- 想象：
  - 平静期：每天涨跌都不大，看起来像“小抖动”。
  - 剧烈期：连续几天或几周，大涨大跌频繁出现。
- 把极端波动日画在价格图上，你会看到这些点不是均匀散落，而是成片出现。

#### 3.3 对交易的意义
- **风险集中**：大部分极端风险发生在少数时间段内。
- **仓位管理**：
  - 在高波动期盲目加杠杆，很容易遇到连续极端波动导致爆仓或大回撤；
  - 高波动期可以适当减仓或提高风控要求。
- **策略设计**：
  - 可以考虑“遇到极端波动后的几天”单独研究策略表现，看是否需要特殊规则（例如暂停交易、缩小仓位）。

---

### 4. 多时间窗口波动对比：你要看“近视眼”还是“远视眼”

#### 4.1 数学思想
- 同样是“滚动波动率”，选择不同的窗口长度：20 日、60 日、120 日，会得到三条不同的曲线。
- 窗口越短：更看重“最近”的信息，反应更灵敏但更吵；
- 窗口越长：更平滑，强调长期水平但反应滞后。

#### 4.2 直观理解
- 20 日：像看最近一个月的情绪，很敏感；
- 60 日：更像季度视角；
- 120 日：半年的总体“波动印象”。

#### 4.3 对交易的意义
- **多尺度认识风险**：
  - 短期高波动但长期仍处于正常范围 → 可能只是短期噪音；
  - 短期和长期波动都升高 → 说明市场整体进入“高风险阶段”。
- **参数选择依据**：
  - 做日线策略时，常见的“20 日波动率”等参数，并不是随便选的，而是和交易周期、持仓周期相关。

---

### 5. 时间特征与“因子化思维”：给每一行数据贴标签

#### 5.1 数学思想
- 在原始 K 线数据的基础上，增加一些“描述这个日期属性”的列：
  - 星期几（0-6）；
  - 是否周末；
  - 甚至可以扩展为：月度、节假日前后等。
- 然后按这些标签分组，统计每组的平均收益率、标准差。

#### 5.2 直观理解
- 就像对人打标签：
  - 年龄、性别、职业……
- 对日期打标签：
  - 周一、周五、周末……
- 统计后，你会看到“周一平均涨幅怎样，周五怎样”，这就是最原始的“因子”雏形。

#### 5.3 对交易的意义
- **因子化思维**：
  - 一列特征（比如“是否周一”）就是一种“解释收益差异的角度”。
- **规律挖掘**：
  - 如果某些星期几平均收益率显著不同，就可能有“日历效应”；
  - 即使不能直接拿来做策略，也能帮助你理解市场行为。

---

### 6. 小结：用“状态”组织时间序列理解

- 通过本周内容，你可以从三个层次看市场：
  - **波动大小**：用滚动标准差衡量；
  - **短期结构**：用滚动自相关判断偏趋势/偏震荡；
  - **时间标签**：用星期几等特征观察“日历效应”。
- 这些都在为一个核心目标服务：
  - 把市场切分成不同“状态”，并研究每种状态下策略是否好用。

---

## 二、第6周：技术指标体系与交易成本建模

### 1. 布林带（Bollinger Bands）：用“均值 ± 波动”画出价格活动区间

#### 1.1 数学思想
- 中轨：最近 N 日的移动平均（MA）。
- 上轨：中轨 + k × 最近 N 日的标准差；
- 下轨：中轨 - k × 最近 N 日的标准差。
- N 控制“看多长时间”，k 控制“区间宽窄”。

#### 1.2 直观理解
- 中轨：价格中线，类似“正常价位”的平滑版本。
- 上/下轨：在当前波动水平下，价格“活动的大致范围”。
- 波动变大时：标准差变大，带子自动变宽；
- 波动变小时：标准差变小，带子自动变窄。

#### 1.3 对交易的意义
- **动态区间**：比固定价位更智能，能自动适应高波动/低波动阶段。
- 常见用法（仅作直觉，不是固定规则）：
  - 价格触及上轨：可能代表“较高位置”，有些人会考虑减仓或做均值回归；
  - 价格触及下轨：可能代表“较低位置”，有些人会考虑买入或反弹；
  - 价格沿着上轨一路上涨：说明强势趋势，简单“反转做空”容易被打脸。
- 关键：布林带不是“绝对买卖点机器”，而是帮你看价格相对位置和波动环境的工具。

---

### 2. RSI 相对强弱指标：衡量“涨得多还是跌得多”

#### 2.1 数学思想
- 把过去 N 天的涨幅和跌幅分开：
  - 只统计上涨那几天的平均涨幅；
  - 只统计下跌那几天的平均跌幅；
- 计算一个“上涨力量 / （上涨力量 + 下跌力量）”的比例，再映射到 0-100 的区间。
- 常用经验：
  - RSI > 70：上涨力量明显占优，可能偏“过热”；
  - RSI < 30：下跌力量明显占优，可能偏“超跌”。

#### 2.2 直观理解
- 想象一段时间内，多头和空头在拔河：
  - 多头最近赢得多，RSI 就高；
  - 空头最近赢得多，RSI 就低。
- RSI 不是看绝对涨跌多少，而是看“最近涨跌的对比强度”。

#### 2.3 对交易的意义
- 常见用法（仍然是经验性的，不是铁律）：
  - RSI 进入高位区（>70）：说明近期涨得比较猛，有人会警惕回调风险；
  - RSI 进入低位区（<30）：说明近期跌得比较狠，有人会寻找反弹机会。
- 与布林带类似，更重要的是：
  - 帮你判断当前是在“情绪过热”还是“情绪过冷”区域，而不是给出精确买卖点。

---

### 3. 指标封装与复用：把“算指标”变成可复用的积木

#### 3.1 思想：从“复制粘贴代码”到“积木式调用”
- 同样的 SMA、EMA、布林带、RSI，可能会在很多 Notebook 里反复出现。
- 如果每次都手写：
  - 容易出错（参数写错、列名写错）；
  - 不利于维护和统一修改。
- 封装成函数：
  - 例如 `add_bbands(df, window, k)`，`add_rsi(df, window)`；
  - 输入是 DataFrame，输出还是 DataFrame，只是多了几列特征。

#### 3.2 直观理解
- 把常用的指标计算逻辑，做成一个个“乐高积木”：
  - 需要时直接拼起来；
  - 换参数时只改一处。

#### 3.3 对交易的意义
- **提升研究效率**：更快在多币种、多时间段复用同一套指标。
- **减少隐藏 bug**：统一的函数更容易检查正确性。
- **为后续框架打基础**：
  - 阶段2会做回测框架，各种指标封装会直接派上用场。

---

### 4. 手续费模型与简单滑点：从“理想世界”回到“真实世界”

#### 4.1 数学思想
- 理论资金曲线通常默认：
  - 按收盘价无成本买入、卖出；
  - 没有手续费、点差、滑点。
- 现实中：
  - 每次开平仓都要付费（比如单边 0.1%）；
  - 成交价往往比理想价稍差（滑点）；
  - 实际到手收益 = 理论收益 - 交易成本。
- 简化模型：
  - 每当持仓状态改变（开仓/平仓/反向），就乘以一个费用因子，或者直接从收益中扣掉一个固定比例。

#### 4.2 直观理解
- 想象每次交易都要交“过路费”：
  - 交易次数越多，付的总费越多；
  - 高频买卖的小利润，很容易被手续费吃掉。

#### 4.3 对交易的意义
- **很多“看起来很厉害”的曲线，加入手续费后会变得很普通甚至亏损。**
- 重要结论：
  - 策略质量不仅看“每笔盈利多不多”，还要看“交易频率高不高”；
  - 有些策略需要降低交易频率（更慢的参数、更少的无效信号）来对抗成本。
- 在阶段1，把手续费简单建模好，已经能过滤掉一批“只在理想世界赚钱”的策略。

---

### 5. 多币种扩展：检验策略是不是只对某个币“特例好用”

#### 5.1 数学思想
- 在同样的参数、同样的手续费假设下：
  - 把策略复制到 BTC、ETH、其他主流币等多个标的；
  - 对每个标的记录：总收益率、最大回撤、年化波动率、交易次数等指标。
- 相当于在不同“样本”上重复同一实验。

#### 5.2 直观理解
- 如果一个策略：
  - 只在某个币上特别好，其它币都很差 → 可能只是“历史巧合”；
  - 在多个币上表现都还可以 → 更有可能反映了一些共性的规律。

#### 5.3 对交易的意义
- 初步建立“稳健性”意识：
  - 不追求某个币上的历史最优参数；
  - 更关心在多个标的上能否维持中等以上表现。

---

### 6. 小结：从“指标好看”到“策略能落地”

- 第6周补上的关键一环是：
  - 指标只是**特征**，不是“自动赚钱按钮”；
  - 真正影响收益的是：
    - 指标如何组合成规则；
    - 规则在扣除手续费后的表现；
    - 规则在不同标的上的一致性。
- 你需要养成的习惯：
  - 任何策略回测结果，都要看“含手续费版本”；
  - 尽量在多标的上做简单扩展测试；
  - 少盯着历史最优曲线，多思考策略在未来是否有逻辑基础持续生效。

---

## 三、两周内容的整体联系

- **第5周** 让你站在“时间序列结构”的视角看市场：
  - 波动有高低、状态有切换；
  - 趋势和震荡可以用自相关等工具初步刻画；
  - 某些特定时间（星期几等）可能有不同统计特征。
- **第6周** 则把时间序列变成“可操作的策略元素”：
  - 用指标（布林带、RSI 等）把价格转成特征；
  - 用函数封装这些特征，形成可重复的研究流程；
  - 用手续费模型和多币种扩展，把策略放在更接近真实交易的环境里检验。

> 阶段1 的目标不是让你变成数学竞赛选手，而是：
> 能够**读懂行情的结构、写出能复用的分析代码、并在考虑成本的情况下做出基本可靠的策略判断**。
