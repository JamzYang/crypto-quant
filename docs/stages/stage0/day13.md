# Day 13 学习笔记：比特币价格数据分析

## 1. 学习背景与今日目标

今天主要围绕这些内容：

- 收益率、对数收益率
- 波动率、最大回撤
- 夏普比率的意义与局限
- 策略过拟合的风险
- 实战代码中的几个关键点：数据获取、异常处理、可视化与字体兼容

---

## 2. 项目1回顾：比特币价格数据分析

### 2.1 做了什么？

- 使用 `ccxt` 尝试从 Binance 获取 `BTCUSDT` 的历史 K 线数据；
- 当网络连不上 Binance 时，自动切换为本地模拟数据 `generate_mock_data`；
- 基于收盘价计算：
  - 日简单收益率
  - 日对数收益率
  - 各种统计指标（均值、波动率、最大回撤等）；
- 用 Matplotlib 画出：价格曲线、收益率分布、回撤曲线和统计表格，并兼容 macOS + Windows 的中文字体；
- 最终输出图表 `BTC价格分析报告.png` 和数据文件 `btc_data.csv`。

### 2.2 从工程角度的收获

- **网络并不总是可靠的**：直接调 Binance 接口会遇到超时、连接被重置等问题；
- 在代码里加上 **异常处理 + 优雅降级** 非常重要：
  - 优先用真实数据；
  - 实在连不上就回退到模拟数据，保证「程序能跑完」。

这和真实量化交易系统很像：不能因为外部接口一出问题，整个系统就崩溃。

---

## 3. 收益率与对数收益率

### 3.1 数学思想

- **简单收益率**：
  - 公式：`r = P_t / P_{t-1} - 1`
  - 含义：今天比昨天涨了多少百分比。

- **对数收益率**：
  - 公式：`g = ln(P_t / P_{t-1})`
  - 含义：用对数刻度来衡量涨跌幅度，便于做「连续复利」和理论推导。

- 关键数学性质：
  - 多期 **对数收益率可以直接相加**：
    - `ln(P_T / P_0) = ln(P_1/P_0) + ln(P_2/P_1) + ...`
  - 简单收益率不能直接相加，只能连续相乘。

### 3.2 直观理解

- 把收益率想象成「走台阶」：
  - 简单收益率：每一步的高度不一样，要想知道一共升高多少，需要一层一层地乘；
  - 对数收益率：把每一步的高度变成「可以直接相加」的数字，算总高度更方便。

- 一个典型例子：
  - 第一天 +50%，第二天 -50%
  - 价格：100 → 150 → 75，实际亏了 25%。
  - 简单收益率平均 = (50% + (-50%))/2 = 0%，看起来好像没亏没赚，但钱是真的少了；
  - 对数收益率会更真实地反映「走一圈回来变少了」的事实。

### 3.3 对交易的意义

- 在量化里，经常要把「很多天的收益」合并成「一年的收益」或「整个策略周期的收益」，对数收益率可加的性质非常好用；
- 许多经典价格模型（比如几何布朗运动）默认价格是「对数正态分布」，对应的就是对数收益率近似服从正态分布，方便用均值、方差等工具分析；
- 实战上：
  - 可以同时保存简单收益率和对数收益率；
  - 画图展示收益分布、计算策略表现时，更常用 **对数收益率**。

---

## 4. 波动率与最大回撤

### 4.1 数学思想

- **波动率（Volatility）**：
  - 本质是「收益率的标准差」，衡量收益上下波动的剧烈程度；
  - 年化波动率 ≈ 日收益率的标准差 × √252（假设一年 252 个交易日）。

- **最大回撤（Max Drawdown）**：
  - 先计算「净值曲线」：把每天的简单收益率累乘起来；
  - 然后在这条曲线中，找出从历史最高点到后面某个低点的最大跌幅；
  - 数学上：`(当前净值 - 历史最高净值) / 历史最高净值`，取最小值就是最大回撤。

### 4.2 直观理解

- 波动率：
  - 好比坐过山车时「上下起伏」的激烈程度；
  - 波动越大，心跳越快，资金曲线越「锯齿」。

- 最大回撤：
  - 好比你账户曾经到过 100 万，然后最惨的时候跌到 60 万，那就是 -40% 的最大回撤；
  - 它回答的是：
    - 「在最痛苦的那一段时间，我亏得有多狠？」
    - 「我能不能在心理和资金上扛得住？」

### 4.3 对交易的意义

- 波动率高 ≠ 一定不好，但意味着：
  - 需要更小的仓位和更严格的风险管理；
  - 不适合所有资金体量和投资者类型。

- 最大回撤是投资者非常敏感的指标：
  - 决定了一个人能不能在策略「暂时失灵」时活下来；
  - 决定了资金方是否愿意长期跟随这个策略。

在今天的项目里，计算最大回撤帮助我从「这条曲线看起来不错」转换到「最糟糕的时候究竟有多糟」。

---

## 5. 夏普比率：越高越好吗？

### 5.1 数学思想

- 夏普比率 = (组合收益率 - 无风险利率) / 波动率；
- 直白解释：**每承担 1 份风险，我平均拿到多少超额收益**。

### 5.2 直观理解

- 想象两个策略：
  - 策略 A：收益比较稳定，一般涨 1%，偶尔波动；
  - 策略 B：有时候涨 10%，有时候跌 10%，过山车一样；
  - 即使它们长期平均收益差不多，我更希望选「单位波动赚得更多」的那个，这就是夏普比率在强调的东西。

### 5.3 局限性与风险

- 夏普比率高 **不代表一定安全**，主要局限：
  - 只看均值和方差，忽略了极端亏损（尾部风险）；
  - 很容易被「收益平滑」技巧美化（比如不及时标记持仓市值）；
  - 对时间窗口很敏感：在牛市里选窗口，夏普会异常好看。

在真实交易中：

- 夏普比率是一个必须看的指标，但绝对不是唯一指标；
- 必须结合最大回撤、回撤持续时间、收益分布形状来一起评估策略好坏。

---

## 6. 策略过拟合：好看的曲线可能是陷阱

### 6.1 数学思想（本质）

- 「过拟合」就是：模型/策略不仅学到了有用的规律，也把**历史噪音当成了规律**；
- 在训练数据（历史回测）上表现非常好，但在新数据上表现很差。

### 6.2 直观理解

- 好比背考试题：
  - 如果只是背住了「这一次考试的答案」，下次换一套试卷就不会；
  - 真正有用的是「学会解题方法」，面对新题也能应对。

- 过拟合的策略：
  - 看起来像是「完美复盘历史」；
  - 实际上只是在「记住历史里所有偶然出现的模式」。

### 6.3 对交易的意义与防范

- 如果策略过拟合：
  - 上线后往往迅速走样，回撤远超回测；
  - 投资者和自己都会对结果非常失望。

- 常见的防范思路：
  - 划分训练集/验证集/测试集，不在同一段数据上「又调参又评估」；
  - 用简单、参数少的策略优先于极其复杂的规则堆砌；
  - 做参数敏感性分析：一大片参数区域表现都不错，比只有某个「神奇点」好很多；
  - 做 Walk-forward（滚动回测），更贴近真实使用场景。

---

## 7. 代码实践与工程小结

### 7.1 数据获取与异常处理

- 使用 `ccxt` 从 Binance 拉取 `BTCUSDT` 历史数据；
- 当出现网络超时、连接被重置等错误时：
  - 捕获 `RequestTimeout`、`NetworkError` 等具体异常；
  - 打出日志和友好提示；
  - 自动回退到 `generate_mock_data` 生成模拟数据，保证后续分析可以继续进行。

这让我意识到：

- 量化程序不能只考虑「网络正常、接口都好用」的理想情况；
- 要把「接口挂了怎么办」作为常规场景设计进去。

### 7.2 可视化与字体兼容

- 使用 Matplotlib 绘制价格曲线、收益率直方图、回撤曲线和统计表；
- 为了兼容 macOS 和 Windows 的中英文字体，写了一个自动选择字体的小函数：
  - 从常见的中文字体列表里（如 Microsoft YaHei、SimHei、PingFang SC 等）自动检测系统实际存在的字体；
  - 找到可用字体后配置到 `plt.rcParams['font.sans-serif']`；
  - 同时禁用坐标轴负号乱码问题（`axes.unicode_minus = False`）。

这保证了：

- 同一份代码在不同系统上都能正常显示中文标题和标签；
- 输出的图表可以直接用于报告和学习笔记。

### 7.3 Pandas 与 NumPy 的配合

- 使用 Pandas 处理时间序列：
  - 把时间戳转成 `DatetimeIndex`，以日期为索引；
  - 使用 `pct_change()` 计算简单收益率；
- 使用 NumPy 生成模拟价格路径：
  - 利用正态分布随机数模拟「价格随机游走」。

---

## 8. 下一步计划（展望 Day 14 之后）

- 按照学习计划中的扩展练习，继续推进：
  - 在现有 BTC 代码的基础上，增加 ETH 数据分析；
  - 对比 BTC 和 ETH 的统计特征（收益率、波动率、最大回撤）；
  - 分析 BTC 与 ETH 的相关性（相关系数）；
  - 写一份约 500 字的分析小报告，练习用文字总结量化结论。

- 在后续项目中不断重复这个套路：
  - 先理解数学思想；
  - 再用生活直觉去消化；
  - 最后落实到「这个东西对交易策略有什么用」。

这份 Day 13 笔记，是我从「跑完一个脚本」往「真正理解背后逻辑」迈出的第一步。