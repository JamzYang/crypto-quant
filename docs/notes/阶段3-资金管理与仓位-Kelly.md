## 阶段 3 第 3 块：资金管理、仓位模板与简单 Kelly 学习笔记

### 0. 本块的学习目标（结果导向）

读完并实践完这一块后，我应该能够独立做到：

- **讲清楚**：
  - 固定金额、固定比例、波动率调整仓位这三种基本仓位方法的差别；
  - Kelly 公式的直觉含义（不是推导），以及为什么「全 Kelly」往往太激进；
  - 为什么仓位管理要和前一块的风控规则、当前组合状态挂钩。
- **设计** 一套适合自己阶段的「三档仓位模板」：
  - 保守档、标准档、激进档；
  - 为每一档明确规定：
    - 单笔风险上限；
    - 总仓位上限；
    - 大致目标波动水平。
- **写出** 一套简化版的 Kelly 思路：
  - 基于某个策略的历史胜率、盈亏比或长期均值/波动率估算「合理的上限仓位」；
  - 用「半 Kelly / 四分之一 Kelly」等方式将理论值压缩到自己能承受的水平。
- **实现与回测**：
  - 在组合回测代码中，引入简单的仓位模板切换逻辑（例如根据组合回撤或主观风险偏好）；
  - 对比不同模板下的收益/回撤变化。

---


### 2. 本块的核心问题 & 直觉图景

- **核心问题 1：我到底该用多大仓位？**
  - 很多人只凭感觉「现在行情很好，可以重仓」，结果一波回撤就情绪失控；
  - 更合理的做法是：
    - 事先定义几档仓位模板；
    - 依据客观条件（如回撤、波动、资金规模）在模板间切换。

- **核心问题 2：固定金额 vs 固定比例 vs 波动率调整**
  - 固定金额：每次买 1000 美金，账户变大了也不变；
  - 固定比例：每次用资金的 10% 做一笔，资金增长时同样按比例放大；
  - 波动率调整：在高波动期降低仓位，在低波动期放大仓位，以控制整体风险。

- **核心问题 3：Kelly 公式的直觉是什么？**
  - Kelly 给出的是在「长期无限次重复某赌博」下，让资产几何平均增长率最大的仓位比例；
  - 但它对参数估计非常敏感，而且隐含了你能承受极大回撤的假设；
  - 对于现实交易者，更常用的是「部分 Kelly」（例如 1/2、1/4 Kelly）。

**直觉图景**：

- 把仓位看成「油门踏板」：
  - 趋势与均值回归等策略是「发动机」；
  - 风控规则是「刹车与安全带」；
  - 仓位管理是「油门」：你可以有很好的发动机和刹车，但如果油门一直踩到底，车照样会出事。

---

### 3. 关键概念与术语说明

#### 3.1 固定金额（Fixed Amount Positioning）

- **定义**：
  - 每次下单使用固定金额的资金，例如每次 1000 USDT；
  - 不随账户规模变化调整。

- **特点**：
  - 简单直观，适合账户规模变化不大的阶段；
  - 当账户大幅增长后，仓位相对变小，会压制收益；
  - 当账户大幅缩水后，仓位相对变大，可能拉高风险。

#### 3.2 固定比例（Fixed Fractional Positioning）

- **定义**：
  - 每次交易使用当前账户资金的一定比例，例如 5% 或 10%；

- **特点**：
  - 随资金规模自动伸缩，亏损时自动「缩表」、盈利时自然「扩表」；
  - 是最常见、也最适合作为起点的仓位方法。

#### 3.3 波动率调整仓位（Volatility Targeting）

- **直觉解释**：
  - 同样是 10% 仓位，如果标的年化波动率是 20% 和 100%，感受到的风险完全不同；
  - 波动率调整仓位就是：
    - 依据最近一段时间的波动率（例如滚动标准差）来放大或缩小仓位，力图控制整体风险水平。

- **简单形式**：
  - 目标波动率 `target_vol`；
  - 估算某策略未来的波动率 `sigma_est`；
  - 令仓位比例约为 `position ≈ target_vol / sigma_est`（再加上上限约束）。

#### 3.4 Kelly 公式（Kelly Criterion）——直觉版

- **最简单的抛硬币例子**：
  - 假设有一个游戏：
    - 赢的概率 `p`；
    - 输的概率 `q = 1 - p`；
    - 赢时获得 `b` 倍收益（例如下注 1，赢了得到 1*b 的净收益）。
  - Kelly 公式给出的最优下注比例：
    - `f* = (p * (b + 1) - 1) / b`，常见简化形式为 `f* = p - q / b`。

- **直觉理解**：
  - 如果 `p` 和 `b` 足够好（优势大），`f*` 就偏大；
  - 如果 `p` 仅略高于 50% 或盈亏比一般，`f*` 会比较小；
  - 这个 `f*` 是在「理论长期极限」下最优，但对实际交易者来说通常太激进。

- **部分 Kelly**：
  - 实际中很多人只会用 `0.25 * f*`、`0.5 * f*` 甚至更低，
  - 以换取更温和的回撤和更可接受的心态波动。

#### 3.5 单笔风险（Risk per Trade）与总仓位上限

- **单笔风险**：
  - 「如果触发止损，这一笔最多亏账户多少百分比？」
  - 常见值在 0.25%~1% 区间，视风险偏好而定。

- **总仓位上限**：
  - 限制「所有策略叠加之后的总风险暴露」，避免无意间满仓甚至超仓；
  - 例如：
    - 保守档：总仓位不超过账户资金的 50%；
    - 标准档：不超过 80%；
    - 激进档：不超过 100%（不使用杠杆）。

---

### 4. 仓位模板画像：保守 / 标准 / 激进

设计三档模板的思路：

1. **保守档**：
   - 适合组合刚上线、策略数量较少或对回撤极度敏感时使用；
   - 特征：
     - 单笔风险：不超过账户资金的 0.25%~0.5%；
     - 总仓位上限：50%；
     - 趋势与均值回归等策略的基础权重降低，例如：
       - 趋势：30%；
       - 均值回归：20%；
       - 其余留作现金。

2. **标准档**：
   - 作为正常运行状态下的默认模板；
   - 特征：
     - 单笔风险：不超过 0.5%~1%；
     - 总仓位上限：80%；
     - 策略基础权重：
       - 趋势：40%；
       - 均值回归：40%；
       - 20% 现金缓冲。

3. **激进档**：
   - 只在组合状态良好、回撤较小、且你主观风险偏好较高时使用；
   - 特征：
     - 单笔风险：不超过 1%（如果心理承受低，可以设成 0.75%）；
     - 总仓位上限：100%；
     - 策略基础权重略向你更看好的风格倾斜：
       - 趋势：60%；
       - 均值回归：40%。

仓位模板与前一块风控规则要互相呼应，例如：

- 当组合回撤 `DD_port` 低于某个阈值（如 10%）时，可以允许「标准/激进」档；
- 当 `DD_port` 超过预警阈值（如 15%）时，强制切回「标准/保守」档；
- 当 `DD_port` 超过严重阈值（如 25%）时，只允许保守档或直接空仓休息。

---

### 5. 中文规则 → 完整描述（示例仓位与 Kelly 上限）

结合前两块的内容，给出一套示例规则（你可以之后按自己的偏好调整数字）：

1. **基础假设**：
   - 使用阶段 3 第 1 块中的两策略组合（趋势 + 均值回归）；
   - 已经有一套风控规则（单策略回撤阈值 + 组合回撤阈值）。

2. **单笔风险上限**：
   - 在「标准档」下：
     - 每笔交易最大风险 `risk_per_trade_std = 0.5%`；
   - 在「保守档」下：
     - `risk_per_trade_conservative = 0.25%`；
   - 在「激进档」下：
     - `risk_per_trade_aggressive = 1.0%`（谨慎使用）。

3. **总仓位上限与策略权重**：
   - 保守档：
     - 总仓位上限：50%；
     - 趋势策略：30%；
     - 均值回归策略：20%；
   - 标准档：
     - 总仓位上限：80%；
     - 趋势策略：40%；
     - 均值回归策略：40%；
   - 激进档：
     - 总仓位上限：100%；
     - 趋势策略：60%；
     - 均值回归策略：40%。

4. **简化 Kelly 上限示例**：
   - 假设通过历史回测估计出某策略的：
     - 胜率 `p ≈ 0.55`；
     - 盈亏比 `b ≈ 1.2`；
   - 则近似 Kelly 仓位：
     - `f* ≈ p - (1 - p) / b`；
   - 假设算出来是 `f* ≈ 0.15`（15%），
   - 出于保守考虑：
     - 只使用 `f_eff = 0.25 * f* ≈ 3.75%` 作为该策略的「理论上限仓位比例」；
   - 再与前面的「总仓位上限」结合，最终限制在一个更保守的范围内。

5. **仓位模板与组合回撤的联动**：
   - 如果组合回撤 `DD_port`：
     - `< 10%`：允许在标准档与激进档之间切换（由主观判断决定）；
     - `10% ~ 15%`：强制降到标准档；
     - `15% ~ 25%`：强制降到保守档；
     - `> 25%`：仅允许保守档，甚至完全空仓，直到完成深度复盘。

---

### 6. 从中文描述到伪代码

```text
输入：
  - 时间序列 t = 1...T
  - 组合回撤 DD_port[t]
  - 策略原始仓位（未考虑仓位模板） position_i_raw[t]

参数：
  - risk_per_trade_conservative, risk_per_trade_std, risk_per_trade_aggressive
  - total_exposure_conservative = 0.5
  - total_exposure_std          = 0.8
  - total_exposure_aggressive   = 1.0
  - base_weight_trend, base_weight_mr 对应三档模板

1. 根据组合回撤选择当前档位 level[t]：
   if DD_port[t-1] < 0.10:
       level[t] = "standard" 或 "aggressive"（可根据主观偏好设定）
   elif DD_port[t-1] < 0.15:
       level[t] = "standard"
   elif DD_port[t-1] < 0.25:
       level[t] = "conservative"
   else:
       level[t] = "conservative" 或 "flat"  # flat 表示空仓

2. 为每个档位设定总仓位上限和策略基础权重：
   if level[t] == "conservative":
       total_exposure = 0.5
       w_trend_base   = 0.3
       w_mr_base      = 0.2
   elif level[t] == "standard":
       total_exposure = 0.8
       w_trend_base   = 0.4
       w_mr_base      = 0.4
   elif level[t] == "aggressive":
       total_exposure = 1.0
       w_trend_base   = 0.6
       w_mr_base      = 0.4

3. 结合前一块的风控系数 pos_factor_i[t]：
   对每个策略 i：
       w_i_temp = 对应的 w_i_base * pos_factor_i[t]  # 来自风控模块

   归一化：
       total_w_temp = w_trend_temp + w_mr_temp
       if total_w_temp > 0:
           w_trend = total_exposure * w_trend_temp / total_w_temp
           w_mr    = total_exposure * w_mr_temp    / total_w_temp
       else:
           w_trend = 0
           w_mr    = 0

4. 将策略原始仓位缩放到目标仓位：
   对每个策略 i：
       position_i_target[t] = w_i * sign(position_i_raw[t])

   在更精细的实现中，可以进一步引入单笔风险约束来微调每一笔交易的具体规模。
```

---

### 7. 实战任务设计（对应路线图任务 3-3）

1. **任务 3-3-1：定义并记录三档仓位模板**
   - 在本笔记或单独的配置文件中，明确写出：
     - 每一档的单笔风险上限；
     - 总仓位上限；
     - 趋势/均值回归等策略的基础权重；
   - 目标是「一眼能看懂当前在用哪一档，以及各自含义」。

2. **任务 3-3-2：在组合回测中实现模板切换逻辑**
   - 将组合回撤 `DD_port` 与档位切换规则编码进回测脚本；
   - 输出每个交易日对应的档位时间序列，便于之后做分析和画图。

3. **任务 3-3-3：回测不同模板下的表现**
   - 分别用：
     - 一直使用保守档；
     - 一直使用标准档；
     - 一直使用激进档；
     - 根据回撤动态切换档位；
   - 对比四种情形下的：
     - 总收益、年化收益；
     - 年化波动率；
     - 最大回撤；
     - Sharpe 比率。

4. **任务 3-3-4：Kelly 直觉实验（可选进阶）**
   - 选一个你最熟悉的单策略：
     - 估算其胜率和盈亏比，算一遍 Kelly 理论值；
     - 设定 1/4、1/2 Kelly 等几组对应的最大单笔风险；
     - 用小规模回测对比这些不同风险水平下的资金曲线形态。

---

### 8. 常见坑与自查清单

1. **把 Kelly 当成「必须用满」的神奇公式**：
   - 忽略 Kelly 对参数估计误差极其敏感这一事实；
   - 现实中更推荐「部分 Kelly」或直接不用 Kelly，而是使用更朴素的风险上限规则。

2. **忽略仓位与心理承受能力的关系**：
   - 即便从数学上看某个仓位数组合更优，
   - 如果其回撤形态超出你的心理承受范围，你大概率会在最不该放弃的时候放弃。

3. **仓位模板与风控规则不一致**：
   - 例如：
     - 组合已经进入严重回撤区间，但模板仍维持在激进档；
   - 应该强制用代码把两边绑定起来，而不是靠主观记忆。

4. **过度频繁地在模板间切换**：
   - 过于频繁的切换可能放大交易成本，也会让策略表现难以解释；
   - 建议在规则中加入「最小停留时间」或「观测窗口」，避免日内情绪所致的剧烈切换。

---

### 9. 小结与下一步

**这一块我已经搞清楚了什么？**

- 固定金额、固定比例、波动率调整仓位三种方法的区别；
- Kelly 公式的直觉含义和为什么要用部分 Kelly；
- 如何把三档仓位模板与组合回撤、风控规则结合起来，形成一套可执行的资金管理框架。

**还有哪些地方暂时没想透？**

- 如何在多策略、多标的环境下做更精细的「资本分配」和「风险平价」；
- 如何在考虑交易成本和滑点的前提下优化仓位调整频率。

**下一步自然的学习方向：**

1. 在现有组合 + 风控框架上，完整实现三档仓位模板，并跑一轮回测对比；
2. 将三个阶段 3 学习块的结果汇总成一份「阶段 3 综合报告」，
   - 总结：
     - 目前策略组合结构；
     - 风控与仓位模板配置；
     - 关键指标与风险暴露；
   - 为阶段 4 的「系统化运营与小型私募思维」打下清晰的基础。
