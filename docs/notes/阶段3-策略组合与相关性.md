## 阶段 3 第 1 块：策略组合与相关性学习笔记

### 0. 本块的学习目标（结果导向）

读完并实践完这一块后，我应该能够独立做到：

- **对比解释**：用自己的话说明「单策略」和「多策略组合」在风险与收益视角上的根本区别。
- **讲清楚**：
  - 什么是策略组合；
  - 为什么相关性对组合降波动非常关键；
  - 为什么「多个策略」不自动等于「分散了风险」。
- **写出** 一套「两策略等权组合」的中文规则，基于已经实现的单策略回测结果（例如双均线趋势 + 布林带均值回归）。
- **翻译** 这套规则为伪代码，并在实现时刻意规避：
  - 未来函数（不能用未来收益来决定当天权重）；
  - 在同一段历史上反复调权重的过拟合。
- **实现与回测**：
  - 能拼接出两个策略的日收益序列；
  - 写出一个简单的「两策略等权组合」回测脚本；
  - 输出组合资金曲线和基础指标（收益、波动率、最大回撤、Sharpe）。
- **评估与复盘**：
  - 能从结果中看出「组合 vs 单策略」在波动率与最大回撤上的差异；
  - 能用直观语言回答：这个组合到底有没有帮我「更稳一点」。

---


### 2. 本块的核心问题 & 直觉图景

本块围绕几个核心问题展开：

- **核心问题 1：多个策略真的能帮我降低风险吗？**
  - 很多人口头上说「我要多策略分散风险」，但如果策略之间高度相关，实盘上仍然可能是「一起大赚、一块大亏」。

- **核心问题 2：相关性在组合中到底起什么作用？**
  - 为什么说「相关性不高」的策略更适合放在一个组合里？
  - 在极端行情里，为什么很多策略的相关性会突然上升？

- **核心问题 3：如何在代码层面实现一个最简的两策略组合？**
  - 假设我已经有两个策略的日收益序列，怎样把它们「拼在一起」？
  - 怎样写一个干净、无未来函数的组合回测骨架？

**直觉图景**：

- 把每个策略想象成一个「员工」：
  - 趋势策略员工：擅长在有明显方向的行情里「顺势而为」。
  - 均值回归员工：擅长在箱体震荡里反复「高抛低吸」。
- 策略组合：
  - 就像公司不把所有业务都押在同一个员工身上，而是让不同部门分工：
    - 有的负责「顺风时扩张」；
    - 有的负责「逆风时稳定现金流」。
- 相关性：
  - 如果两个员工总是一起开心一起崩溃（收益高度同步），那其实「只是复制了一个自己」，并没有真正分散风险。

---

### 3. 关键概念与术语说明

#### 3.1 策略组合（Strategy Portfolio）

- **直觉解释**：
  - 不再把所有资金押注在单一策略上，而是按一定比例分配给多种策略，让它们「各显神通」。
  - 希望通过不同风格的策略，在不同市场环境下轮流发挥，从而让整体资金曲线更平滑。

- **简化的数学视角**：
  - 假设有两个策略：
    - 策略 A：日收益率为 `ret_A(t)`；
    - 策略 B：日收益率为 `ret_B(t)`；
  - 当天给它们分配的资金权重为 `w_A(t)` 和 `w_B(t)`，且 `w_A(t) + w_B(t) ≤ 1`；
  - 则组合日收益近似为：
    - `ret_port(t) = w_A(t) * ret_A(t) + w_B(t) * ret_B(t)`。

#### 3.2 相关性（Correlation）

- **直觉解释**：
  - 衡量两个序列「一起涨一起跌」的程度：
    - 高度正相关：涨跌节奏基本同步；
    - 低相关：有时一个涨一个跌，有时一起涨或一起跌，整体上关系不紧；
    - 负相关：一个涨时另一个更容易跌，反之亦然。

- **在策略组合中的含义**：
  - 如果两个策略长期高度正相关：
    - 放在一起的效果更像是「加大杠杆」而不是「降低风险」。
  - 如果两个策略相关性较低：
    - 在某些阶段，A 亏损时 B 不一定亏，甚至在赚钱；
    - 组合的整体波动和回撤有机会变小。

#### 3.3 等权组合（Equal-weight Portfolio）

- **定义**：
  - 给每个策略分配相同的资金比例，例如两个策略就是 50%/50%。

- **优点**：
  - 非常直观、易实现；
  - 不需要复杂的优化算法或数学推导；
  - 作为组合实验的起点非常合适。

- **局限**：
  - 没有考虑单个策略本身的波动大小、最大回撤等差异；
  - 当一个策略特别不稳定而另一个相对稳健时，等权分配可能不是最优选择。

#### 3.4 组合收益和组合波动

- **组合收益**：
  - 某一时间段内组合资金曲线从起点到终点的整体涨幅。

- **组合波动**：
  - 用日收益率序列的标准差来衡量价格（或资金曲线）晃动的剧烈程度；
  - 波动越大，资金曲线越「锯齿状」，回撤通常也更大。

---

### 4. 策略画像：两策略等权组合实验（以趋势 + 均值回归为例）

这里以阶段 2 中的两个代表性策略为例：

- **策略 A：双均线趋势跟随策略（只做多）**
  - 假设在 `src/stage2/strategies` 里已经实现；
  - 在单独回测中，主要在有明显上升/下降趋势的行情中贡献收益，在震荡市容易频繁止损。

- **策略 B：布林带均值回归策略（只做多）**
  - 通过价格相对于布林带上下轨的偏离程度，博弈「回到中轨」这一段路；
  - 在箱体震荡中容易多次获利，在大趋势行情中容易「接飞刀」。

**组合直觉**：

- 在**趋势主导的行情**中：
  - 策略 A 更容易赚钱；
  - 策略 B 尝试抄底可能频繁受伤；
  - 等权组合会「稀释」一部分趋势策略的收益，但也可能在某些震荡阶段缓冲回撤。

- 在**箱体震荡行情**中：
  - 策略 B 更容易受益；
  - 策略 A 频繁假突破、虚假止损；
  - 等权组合会用均值回归策略的收益，来抵消一部分趋势策略的亏损。

总体目标：

- 不一定追求「组合收益一定 > 任意单策略」；
- 更希望看到：
  - 组合的波动率是否明显低于至少一个单策略；
  - 最大回撤是否有所收敛；
  - Sharpe 比率是否有提升。

---

### 5. 中文规则 → 完整描述（两策略等权组合）

在不考虑风控、仓位档位、Kelly 的前提下，先写一个最简版两策略组合规则：

1. **输入假设**：
   - 已经从单策略回测中获取：
     - 策略 A 的日收益序列 `ret_A(t)`；
     - 策略 B 的日收益序列 `ret_B(t)`；
   - 两个策略使用**相同标的**（例如 BTC/USDT 日线）和**相同时间区间**；
   - 两个收益序列已经对齐到同一组交易日。

2. **资金初始值**：
   - 组合账户初始资金 `equity_port(0) = 1.0`（1 单位）。

3. **权重设定（等权）**：
   - 每天对两个策略分配相同权重：
     - `w_A(t) = 0.5`；
     - `w_B(t) = 0.5`；
   - 不使用额外杠杆，即 `w_A(t) + w_B(t) = 1`。

4. **组合日收益计算**：
   - 对于每一个交易日 `t ≥ 1`：
     - `ret_port(t) = w_A(t) * ret_A(t) + w_B(t) * ret_B(t)`。

5. **组合资金曲线计算**：
   - `equity_port(0) = 1.0`；
   - 对于 `t = 1...T`：
     - `equity_port(t) = equity_port(t-1) * (1 + ret_port(t))`。

6. **对比基准**：
   - 单独持有策略 A：
     - 资金曲线 `equity_A(t)` 来自单策略回测；
   - 单独持有策略 B：
     - 资金曲线 `equity_B(t)` 同上；
   - 简单持有标的（Buy & Hold）：
     - 可以选取标的本身的日收益 `ret_bh(t)`，计算 `equity_bh(t)` 作为对照。

7. **输出指标**：
   - 对每一条资金曲线（组合、策略 A、策略 B、BH）计算：
     - 总收益；
     - 年化收益；
     - 年化波动率；
     - Sharpe 比率（简单版本，可用无风险利率 = 0 近似）；
     - 最大回撤及回撤持续时间。

---

### 6. 从中文描述到伪代码

下面是一个偏「伪代码 + pandas 思路」的描述，方便后续落到 `src/stage3` 或 `src/stage2/backtests` 中：

```text
输入：
  - DataFrame df，索引为日期索引
  - 列：
      ret_A   # 策略 A 日收益
      ret_B   # 策略 B 日收益

参数：
  - w_A = 0.5
  - w_B = 0.5

步骤：
1. 计算组合日收益：
   ret_port = w_A * df["ret_A"] + w_B * df["ret_B"]

2. 计算资金曲线：
   equity_port = (1 + ret_port).cumprod()

3. 计算基准资金曲线：
   equity_A = (1 + df["ret_A"]).cumprod()
   equity_B = (1 + df["ret_B"]).cumprod()

4. 计算绩效指标（以组合为例，其它类似）：
   total_return = equity_port.iloc[-1] - 1
   daily_ret    = ret_port
   ann_return   = (1 + total_return) ** (252 / N) - 1  # N 为交易日数量
   ann_vol      = daily_ret.std() * sqrt(252)
   sharpe       = ann_return / ann_vol  # 简化假设无风险利率为 0

   # 最大回撤：
   running_max = equity_port.cummax()
   drawdown    = (running_max - equity_port) / running_max
   max_dd      = drawdown.max()
```

在实际代码中，这些步骤可以封装为：

- 一个组合层函数：`compute_two_strategy_equal_weight_portfolio(df_ret)`；
- 一个绩效统计函数：`compute_performance_stats(equity_series)`；
- 保持与阶段 2 中单策略回测的接口风格一致，后续便于叠加风控和资金管理模块。

---

### 7. 实战任务设计（对应路线图中的任务 3-1）

结合路线图中「任务 3-1：两策略组合实验」，可以设定一组具体的小任务：

1. **任务 3-1-1：准备两条策略收益序列**
   - 运行阶段 2 中的：
     - 双均线趋势策略回测脚本；
     - 布林带均值回归策略回测脚本；
   - 统一输出到同一个 CSV 或同一个 DataFrame 中，确保：
     - 日期对齐；
     - 缺失值处理（例如公共区间之外的数据先舍弃）。

2. **任务 3-1-2：实现两策略等权组合函数**
   - 按前面伪代码的逻辑，在 `src/stage3`（或 `src/stage2/backtests`）中实现：
     - 日收益合成；
     - 资金曲线计算；
     - 基础绩效指标统计。

3. **任务 3-1-3：绘制对比图表**
   - 建议至少画：
     - 组合资金曲线 vs 策略 A、策略 B、BH 资金曲线；
     - 三条回撤曲线对比（组合、A、B）。
   - 用肉眼观察：
     - 哪一条曲线最「平滑」？
     - 哪一条在极端大跌阶段最难受？

4. **任务 3-1-4：撰写小结**
   - 用 5–10 行中文回答：
     - 这个两策略等权组合，相比单策略，有没有明显降低波动和最大回撤？
     - 有没有出现「组合收益反而比单个最好策略低很多」的情况？
     - 如果要做第二版改进，你直觉上会：
       - 增加一个新策略？
       - 还是调整权重？

---

### 8. 常见坑与自查清单

1. **错误地使用未来信息调整权重**：
   - 在同一段历史数据上，根据回测结果「调权重再回测」，相当于偷看了答案；
   - 正确做法：
     - 先固定等权组合，完整回测；
     - 再在笔记中记录：如果后续要做「动态权重」，需要另开一块研究并拆分样本内/样本外。

2. **忽略时间对齐问题**：
   - 若策略 A 和 B 使用的起止日期不同，直接相加会导致早期某段只有一个策略在工作；
   - 应显式决定：
     - 只使用两者都存在数据的公共区间；
     - 或者在缺失期将缺失策略的收益视为 0（但要在笔记中写明）。

3. **混淆「两个策略」和「两个标的」**：
   - 本块主要关注「同一标的上的两种策略」的组合；
   - 跨标的组合（多币种、多资产）属于下一层复杂度，可以在后续单独扩展。

4. **只盯着收益，不看回撤与波动**：
   - 组合可能在收益上略逊于某个激进单策略；
   - 但如果回撤和波动显著降低，对「小型私募运营人」来说反而更有价值。

---

### 9. 小结与下一步

**这一块我已经搞清楚了什么？**

- 策略组合的基本概念，以及为什么需要组合而不是押注单一策略；
- 相关性在组合中的角色，理解了「高相关 ≈ 没怎么真正分散风险」这一点；
- 如何在代码层面，把两个单策略的日收益序列等权合成为一个组合，并计算基础绩效指标。

**还有哪些地方暂时没想透？**

- 如何系统地评估多组权重（不是只看 50%/50%）而不过拟合；
- 如何在组合层真正引入「风险贡献」或「风险平价」的概念，而不仅仅是拍脑袋分配资金。

**下一步自然的学习方向（为阶段 3 后续两块做铺垫）：**

1. 在保持等权组合的前提下，开始思考：
   - 如果某个策略的最大回撤远大于另一个，我是否应该给它更少的权重？
   - 这会引出下一块的主题：**风险预算与回撤管理**。

2. 尝试在同一套历史数据上，对比：
   - 只有趋势策略；
   - 只有均值回归策略；
   - 两者等权组合；
   - 并把结果整理成小表格，为后续「风控规则设计」提供直观素材。

3. 在完成上述任务后，再进入阶段 3 第 2 块：
   - 系统设计「单策略回撤阈值」和「组合层回撤阈值」；
   - 学习如何在代码中实现简单的减仓/停用逻辑。
