## 阶段 2 第 4 块：综合复盘 + 简单样本外验证学习笔记

### 0. 本块学习目标（结果导向）

读完并实践完这一块后，我应该能够：

- **说清楚** 什么是样本内（IS）与样本外（OOS）验证，以及它们在策略开发中的角色。
- **搭建** 一个最小的 IS/OOS 对比框架，一次性跑多种策略的样本内/外回测。
- **解读** IS/OOS 指标差异，从中识别过拟合迹象与风格较稳定的策略。
- **输出** 一份阶段 2 综合报告：列出主要策略、各自表现与主观评价，为后续阶段 3 的策略组合做输入。


### 1. 本学习块在整体计划中的位置

- 前三块是「造轮子」：
  - 第 1 块：趋势跟随原型（双均线）。
  - 第 2 块：均值回归原型（布林带）。
  - 第 3 块：波动率调仓模块 + 回测原则。
- 第 4 块开始是「给轮子体检」：
  - 不是再造一个新策略，而是把现有策略放到不同时间区间去跑，看看它们在哪些环境下靠谱、在哪些环境下崩掉。
  - 目标是得到一份面向阶段 3 的「策略候选池评估报告」，而不是单一策略的炫酷收益曲线。


### 2. 样本内 / 样本外的直觉图景

- **样本内 (In-Sample, IS)**：
  - 用来「设计和调整」策略的时间段。
  - 策略参数往往是在这个区间内调出来的，天然容易乐观一点。

- **样本外 (Out-of-Sample, OOS)**：
  - 完全不参与参数调优，专门用于检验策略泛化能力的时间段。
  - 类比成「之前没见过的考题」，看策略是否只会做熟悉的题。

- 一个健康的策略，大致应当满足：
  - IS 表现不错，但不过分夸张；
  - OOS 表现不至于完全崩坏（收益、Sharpe 至少同方向，不至于大幅反转），风格上与 IS 区间相似。


### 3. 本块涉及的主要策略与代码

在本块的综合回测中，我纳入了四条基准/策略：

1. **简单持有 (buy_and_hold)**：
   - 始终满仓持有 BTC/USDT，不做任何择时。

2. **双均线趋势 (ma_trend)**：
   - 使用 `MATrendStrategy` (20/60) 实现的趋势跟随策略。

3. **布林带均值回归 (bollinger)**：
   - 使用 `BollingerMeanReversionStrategy` (N=20, k=2) 实现的只做多均值回归策略。

4. **趋势 + 波动率调仓 (trend_vol)**：
   - 在双均线趋势信号上叠加 `VolatilityAdjuster`，根据滚动波动率缩放仓位。

对应的综合回测脚本：

- **文件**：`src/stage2/backtests/bt_comprehensive_IS_OOS.py`
- 主要函数：
  - `run_strategy_on_data(df, strategy_name, ...)`：在传入的数据段上跑指定策略，返回资金曲线；
  - `run_comprehensive_comparison(csv_path, split_date, ...)`：按照 `split_date` 划分 IS/OOS，并对四种策略分别计算 IS/OOS 指标；
  - `main()`：选取合适的时间切分点（根据当前数据，使用 `2025-06-01` 作为 IS/OOS 边界），执行综合对比并输出表格。


### 4. 数据切分与回测设置

在实际数据中，`dist/btc_data.csv` 的时间范围约为：

- **整体区间**：2024-11-18 ~ 2025-11-17（约 1 年）。

为保证 IS/OOS 各有一定长度，我选取：

- **样本内 (IS)**：2024-11-18 ~ 2025-05-31（约 195 天）；
- **样本外 (OOS)**：2025-06-01 ~ 2025-11-17（约 170 天）。

其他回测设置与前几块保持一致：

- 初始资金：10,000；
- 手续费：`fee_rate=0.001`；
- 年化天数：365。


### 5. IS/OOS 结果总览（数值级别）

从脚本运行得到的大致结果（保留 4 位小数）：

| Strategy       | IS_Return | IS_Sharpe | IS_MaxDD | OOS_Return | OOS_Sharpe | OOS_MaxDD |
|----------------|----------:|----------:|---------:|-----------:|-----------:|----------:|
| buy_and_hold   |  0.1562   |  0.6482   | -0.2810  |  -0.0939   |  -0.5507   | -0.2438   |
| ma_trend       |  0.0005   |  0.0040   | -0.1447  |  -0.0254   |  -0.2135   | -0.1800   |
| bollinger      |  0.0947   |  0.8226   | -0.0816  |   0.0144   |   0.1978   | -0.1108   |
| trend_vol      |  0.0045   |  0.0548   | -0.0876  |  -0.0118   |  -0.1668   | -0.1101   |

（注意：这里是分段 IS / OOS 的「区间总收益」，不是全样本收益。）


### 6. 策略逐个解读

#### 6.1 简单持有 (buy_and_hold)

- IS：收益 +15.6%，Sharpe 约 0.65，最大回撤约 -28%。
- OOS：收益 -9.4%，Sharpe 约 -0.55，最大回撤仍然很大。

**解读**：

- 简单持有对行情极其敏感：
  - IS 时段更偏多头，所以表现亮眼；
  - OOS 时段更偏震荡/回落，直接转为亏损。
- 这说明：
  - 它的「风格」非常清晰：纯趋势 Beta。
  - 想用它作为基准 OK，但不能期待它在任何样本外区间都表现稳定。

#### 6.2 双均线趋势 (ma_trend)

- IS：收益几乎为 0，Sharpe 接近 0，最大回撤 -14.5% 左右。
- OOS：收益约 -2.5%，Sharpe -0.21，最大回撤 -18%。

**解读**：

- 在这段数据上，这个具体参数组合（20/60）：
  - 并没有显著捕捉到趋势收益，
  - 反而在震荡市和趋势切换期里「亏在手续费和假突破」更多。
- 从 IS/OOS 的角度：
  - 它「一直很平庸」，谈不上过拟合，但也没有明显 alpha。

#### 6.3 布林带均值回归 (bollinger)

- IS：收益约 +9.5%，Sharpe ~ 0.82，最大回撤 ~ -8%。
- OOS：收益约 +1.4%，Sharpe ~ 0.20，最大回撤 ~ -11%。

**解读**：

- 这是四个里面**最接近「风格稳定」**的策略：
  - IS 区间表现良好但不过分夸张；
  - OOS 区间仍然是正收益，Sharpe 变低但没有反转成巨亏。
- 结合前一块对布林带的直觉：
  - 在当前这段数据里，震荡/小趋势段可能占比较高，均值回归更容易找到机会。

#### 6.4 趋势 + 波动率调仓 (trend_vol)

- IS：收益略为正（+0.45% 左右），Sharpe ~ 0.055，最大回撤约 -8.8%。
- OOS：收益略为负（-1.2% 左右），Sharpe ~ -0.17，最大回撤约 -11%。

**解读**：

- 从「赚钱」角度看，它并不优秀；
- 但从「风险控制」角度看，它的最大回撤显著小于简单持有和原始趋势策略；
- 更像是一个 overlay：
  - 本身不是 alpha 源；
  - 但可以在已有信号策略之上压缩波动和回撤。


### 7. 过拟合与风格稳定性的初步判断

从 IS/OOS 对比中，我得到的印象：

- **简单持有**：
  - IS 好、OOS 差，更多反映「宏观市场环境切换」，而不是典型的数据挖掘式过拟合。

- **双均线趋势**：
  - IS/OOS 都平庸偏差，说明当前参数在这段数据上没有明显优势；
  - 不算过拟合，但也称不上可用策略，更像一个对「趋势世界观」的练习样本。

- **布林带均值回归**：
  - IS 有不错表现，OOS 略弱但同向、仍为正；
  - 风格在两段时间内较一致，是最值得继续打磨的候选。

- **趋势 + 波动率调仓**：
  - 主要价值在于降低波动和回撤，而不是拉高收益；
  - IS/OOS 的收益都接近 0，但回撤控制较好，适合后续作为「风险管理模块」的一部分，而非单独策略。


### 8. 阶段 2 综合结论（面向阶段 3 ）

基于目前实现与 IS/OOS 结果，我对几个策略的主观判断：

- **简单持有**：
  - 优点：结构最简单，完全不担心未来函数或过拟合；
  - 缺点：对市场环境极度敏感，回撤巨大；
  - 适合：作为基准线和「最朴素的替代方案」放在报告里对比，而非真正执行策略。

- **双均线趋势**：
  - 优点：规则直观易懂，是趋势跟随世界观的良好教学样本；
  - 缺点：在当前样本上没有展现出超越简单持有的能力，且容易在震荡市被来回打脸；
  - 适合：保留为「趋势模块雏形」，但在真实资金上单独上场前需要更深的参数和结构研究。

- **布林带均值回归**：
  - 优点：在 IS 和 OOS 上都有正收益，回撤可控，Sharpe 表示出一定程度的风险收益平衡；
  - 缺点：参数和规则仍然较为朴素，尚未考虑更精细的仓位管理和风险约束；
  - 适合：作为阶段 3 的重点候选之一，值得进一步做样本外扩展和参数敏感性分析。

- **趋势 + 波动率调仓**：
  - 优点：显著压缩了回撤和波动，对「控制账户损失速度」有帮助；
  - 缺点：在当前参数下难言 alpha，更像是风险管理工具；
  - 适合：未来叠加在「有一定 alpha 的底层策略」上，将其转化为「风险相对更可控的版本」。


### 9. 下一步：第 5 块（回顾与重构）的聚焦方向

基于这份综合报告，第 5 块（机动时间）的自然方向是：

1. **选择重点策略做重构与敏感性分析**：
   - 第一优先：布林带均值回归策略；
   - 第二优先：趋势 + 波动率调仓作为风险管理模块。

2. **在代码层面做的事**：
   - 抽取公共的回测与评估逻辑（减少重复）；
   - 为关键策略写一两个「参数网格测试」的小脚本；
   - 清理和统一命名风格、注释和目录结构，让后续扩展更容易。

3. **在逻辑层面做的事**：
   - 思考「哪些结果是纯噪音，哪些是稳定特征」；
   - 为阶段 3 的策略组合与风控列出一个「候选策略清单 + 期待扮演的角色」。

这部分内容会在 `docs/notes/阶段2-回顾与重构.md` 中进一步展开。
