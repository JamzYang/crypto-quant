## 阶段 3 第 2 块：风控规则设计与回撤管理学习笔记

### 0. 本块的学习目标（结果导向）

读完并实践完这一块后，我应该能够独立做到：

- **讲清楚**：
  - 什么是回撤、最大回撤、回撤持续时间；
  - 单笔最大亏损限制、单策略最大回撤限制、组合层最大回撤限制分别在控制什么；
  - 风控规则为什么要「事先写好、事后照做」，而不是临场拍脑袋。
- **写出** 一套适合自己阶段的「三层风控结构」：
  - 单笔交易风险上限（例如每笔不超过总资金 1%）；
  - 单策略回撤预警/停用规则（例如 -10% 预警，-20% 停用）；
  - 组合层回撤阈值与降档规则（例如 -15% 降档，-25% 休息期）。
- **翻译** 这套风控结构为伪代码，能看懂每个 if 条件对应的风险含义；
- **实现与回测**：
  - 在单策略或组合回测的代码骨架上，实现简单的「回撤触发减仓 / 停用」逻辑；
  - 能输出带风控版本 vs 不带风控版本的对比资金曲线与指标。
- **评估与复盘**：
  - 能用数据说明：风控规则如何改变了曲线形状（特别是最大回撤和尾部风险）；
  - 能识别「规则过于严苛导致收益被压得太低」和「规则过于宽松形同虚设」这两种极端。

---


### 2. 本块的核心问题 & 直觉图景

本块主要围绕三个问题：

- **核心问题 1：回撤到底在描述什么风险？**
  - 为什么单看「总收益」不够？
  - 为什么长期生存更在乎「从高点到低点会跌多深、要多久才能回去」？

- **核心问题 2：风控规则应该怎么写，才不是形式主义？**
  - 规则太松：形同虚设，真正崩盘时挡不住；
  - 规则太严：一点小回撤就停用策略，导致长期收益大幅缩水；
  - 关键是：
    - 用过去回测数据估一个「策略能承受的正常波动范围」；
    - 再给自己留一点余量，写在规则里，并在代码里严格执行。

- **核心问题 3：如何在代码中实现「回撤触发减仓/停用」？**
  - 如何计算随时间变化的回撤曲线？
  - 如何将「当回撤超过 X% 且持续 Y 天」翻译成干净的逻辑？

**直觉图景**：

- 把账户想象成坐电梯：
  - 总收益像是你最终到了几层楼；
  - 回撤像是「中途电梯从高层突然掉了几层再上去」；
  - 风控规则就是「规定最多只允许从最高层坐回几层，超过就必须换一部更安全的电梯，或者直接下车休息」。

---

### 3. 关键概念与术语说明

#### 3.1 回撤（Drawdown）与最大回撤（Max Drawdown）

- **回撤**：
  - 在某个时间点 t：
    - 回撤 = 之前见过的最高资金曲线峰值 `peak(t)` 与当前资金 `equity(t)` 的差；
    - 一般用比例表示：`DD(t) = (peak(t) - equity(t)) / peak(t)`。

- **最大回撤**：
  - 在整个回测区间内，`DD(t)` 的最大值；
  - 代表「历史上最惨一次从高点跌到低点的幅度」。

- **回撤持续时间（Drawdown Duration）**：
  - 从某个峰值开始，直到资金曲线重新回到或突破这个峰值所用的时间；
  - 有时你不仅在乎「跌多深」，也在乎「亏了多久才回本」。

#### 3.2 单笔最大亏损限制（Per-trade Risk Limit）

- **直觉解释**：
  - 不允许任何一笔交易的亏损超过账户资金的一个小比例，例如 0.5% 或 1%。

- **常见写法**：
  - 对每笔交易事先设定止损价，使得「从入场价到止损价的亏损金额」不超过账户资金的某个百分比。

#### 3.3 单策略最大回撤限制（Per-strategy Max DD Limit）

- **直觉解释**：
  - 把每个策略当作一个「员工」，不给任何一个员工无限制地持续亏钱；
  - 一旦该策略从历史高点的回撤超过某个阈值，就要减仓或停用。

- **预警 vs 停用**：
  - 预警阈值（例如 -10%）：
    - 提醒「这个策略状态不太对」，可以先减半仓位；
  - 停用阈值（例如 -20%）：
    - 认为「这个策略需要重新审查」，暂时完全停用，资金撤回现金或分配给其他策略。

#### 3.4 组合层最大回撤限制（Portfolio-level Max DD Limit）

- **直觉解释**：
  - 即使每个策略单独看都在合理范围内，整个组合仍可能出现「所有人一起失误」的情况；
  - 组合层最大回撤限制就是：
    - 一旦整体账户从历史高点回撤超过某个比例，必须进行整体降档甚至暂停交易。

#### 3.5 风险预算（Risk Budget）

- **直觉解释**：
  - 类似给每个策略分配「最多能亏多少钱」的额度；
  - 可以基于历史最大回撤来分配：
    - 历史更稳定的策略 → 分配更多风险预算；
    - 历史回撤很大的策略 → 分配更少风险预算。

---

### 4. 风控结构画像：三层刹车系统

把风控想象成三层刹车：

1. **微观层：单笔止损**
   - 防止「一笔交易就爆仓」；
   - 通常用固定金额/百分比或基于波动率（ATR、标准差）设置。

2. **策略层：单策略回撤控制**
   - 防止「某个策略连续犯错，把一个账户拖垮」；
   - 常用规则：
     - 回撤超过预警阈值 → 减半仓位；
     - 回撤超过停用阈值 → 暂停该策略，进入观察期。

3. **组合层：账户整体回撤控制**
   - 防止「所有策略一起踩雷」，引发账户级灾难；
   - 常用规则：
     - 回撤超过第 1 阈值 → 整体降档为更保守模板；
     - 回撤超过第 2 阈值 → 暂停大部分或全部策略，现金为主，专心复盘。

在这个阶段，你不需要把规则设计得非常复杂，更重要的是：

- 真的把规则**写下来**；
- 在**回测代码里实现**，而不是只存在脑子里；
- 用结果来验证：这些规则到底是帮忙还是添乱。

---

### 5. 中文规则 → 完整描述（示例风控结构）

下面给出一套「示例版」规则，便于你在此基础上调整数字：

1. **账户与策略设定**：
   - 总账户资金：`Equity_port(t)`；
   - 有两个主要策略：趋势策略 A、均值回归策略 B；
   - 两个策略在阶段 3 第 1 块中已经实现组合。

2. **单笔最大亏损限制**：
   - 设定每笔交易的最大亏损不超过账户资金的 `risk_per_trade = 1%`；
   - 对每个策略 i：
     - 若计划开仓市值为 `position_value_i(t)`，则其允许的最大点数亏损由：
       - `max_loss_amount_i(t) = Equity_port(t) * risk_per_trade` 决定；
     - 再结合标的价格和合约面值，反推止损价位置。
   - 在本阶段，你可以先只在伪代码层理解，不必马上实现所有细节。

3. **单策略最大回撤限制**：
   - 对每个策略 i：
     - 定义其独立资金曲线 `Equity_i(t)`；
     - 计算随时间变化的峰值 `Peak_i(t)` 与回撤 `DD_i(t)`：
       - `Peak_i(t) = max_{s<=t} Equity_i(s)`；
       - `DD_i(t) = (Peak_i(t) - Equity_i(t)) / Peak_i(t)`。
   - 设定两级阈值（示例）：
     - 趋势策略 A：
       - 预警阈值 `DD_A_warn = 10%`；
       - 停用阈值 `DD_A_stop = 20%`；
     - 均值回归策略 B：
       - 预警阈值 `DD_B_warn = 8%`；
       - 停用阈值 `DD_B_stop = 18%`。
   - 行为规则：
     - 若某时刻 `DD_i(t) > DD_i_warn` 且 `<= DD_i_stop`：
       - 将该策略当日及之后一段时间的目标仓位减半（例如从 1.0 降到 0.5）；
     - 若 `DD_i(t) > DD_i_stop`：
       - 将该策略目标仓位设为 0，暂停新仓，同时在笔记中标记「需复盘」。

4. **组合层最大回撤限制**：
   - 对组合资金曲线 `Equity_port(t)`：
     - `Peak_port(t) = max_{s<=t} Equity_port(s)`；
     - `DD_port(t) = (Peak_port(t) - Equity_port(t)) / Peak_port(t)`。
   - 设定组合层阈值：
     - 预警阈值 `DD_port_warn = 15%`；
     - 严重阈值 `DD_port_hard = 25%`。
   - 行为规则：
     - 若 `DD_port(t) > DD_port_warn` 且 `<= DD_port_hard`：
       - 将当前所有策略的目标仓位整体乘以 0.5（全局降档）；
     - 若 `DD_port(t) > DD_port_hard`：
       - 将所有策略目标仓位设为 0（进入休息期），直到手动复盘后再恢复。

5. **风险预算思路（简版）**：
   - 基于阶段 2 & 第 1 块的历史回测结果：
     - 统计每个策略的历史最大回撤 `MaxDD_i`；
   - 风险预算分配思路：
     - 更稳定（`MaxDD_i` 较小）的策略 → 可以在组合中分配更高权重与更宽松的停用阈值；
     - 更暴躁（`MaxDD_i` 较大）的策略 → 分配更低权重与更紧的停用阈值。

---

### 6. 从中文描述到伪代码

```text
输入：
  - 时间序列 t = 1...T
  - 每个策略 i 的资金曲线 Equity_i[t]
  - 组合资金曲线 Equity_port[t]

参数：
  - 单策略回撤阈值：DD_i_warn, DD_i_stop
  - 组合回撤阈值：DD_port_warn, DD_port_hard

步骤：
1. 计算单策略回撤：
   对每个策略 i：
       Peak_i[0] = Equity_i[0]
       对 t 从 1 到 T：
           Peak_i[t] = max(Peak_i[t-1], Equity_i[t])
           DD_i[t]   = (Peak_i[t] - Equity_i[t]) / Peak_i[t]

2. 计算组合回撤：
   Peak_port[0] = Equity_port[0]
   对 t 从 1 到 T：
       Peak_port[t] = max(Peak_port[t-1], Equity_port[t])
       DD_port[t]   = (Peak_port[t] - Equity_port[t]) / Peak_port[t]

3. 初始化策略状态：
   对每个策略 i：
       state_i = "normal"   # normal / warn / stopped

4. 对 t 从 1 到 T：

   4.1 更新单策略状态：
       对每个策略 i：
           if DD_i[t] > DD_i_stop:
               state_i = "stopped"
           elif DD_i[t] > DD_i_warn and state_i != "stopped":
               state_i = "warn"

   4.2 更新组合层档位：
       if DD_port[t] > DD_port_hard:
           level = "all_stopped"   # 休息期
       elif DD_port[t] > DD_port_warn and level != "all_stopped":
           level = "de_risk"       # 降档
       else:
           if level 未被强制设置为更保守：
               level = "normal"

   4.3 计算当期每个策略的目标仓位系数 pos_factor_i[t]：
       如果 level == "all_stopped":
           对所有策略 i：pos_factor_i[t] = 0
       否则：
           对每个策略 i：
               if state_i == "stopped":
                   base = 0
               elif state_i == "warn":
                   base = 0.5   # 减半
               else:
                   base = 1.0

               if level == "de_risk":
                   pos_factor_i[t] = base * 0.5
               else:  # normal
                   pos_factor_i[t] = base

   4.4 实际在下一个交易日 t+1 使用 pos_factor_i[t] 作为仓位缩放系数。
```

在真正代码实现中，这个 `pos_factor_i[t]` 会与原本策略的信号/仓位相乘：

- 原策略仓位：`position_i_raw(t)`；
- 带风控后的仓位：`position_i_adj(t) = pos_factor_i[t-1] * position_i_raw(t)`（注意用 t-1 避免未来函数）。

---

### 7. 实战任务设计（对应路线图任务 3-2）

1. **任务 3-2-1：为每个单策略绘制回撤曲线**
   - 目标：对阶段 2 中的每个策略，画出：
     - 资金曲线；
     - 回撤曲线（DD 随时间变化）。
   - 任务内容：
     - 在现有回测代码中，增加 `cummax` 和回撤计算；
     - 输出成图表和 CSV，便于后续分析。

2. **任务 3-2-2：设定单策略预警/停用阈值**
   - 目标：根据历史最大回撤，给每个策略设定合理的 warn/stop 阈值；
   - 任务内容：
     - 观察每个策略 `MaxDD`；
     - 以 `MaxDD` 为基础，手动选一对「略低于历史最差」的阈值，写进笔记和配置。

3. **任务 3-2-3：在回测中加入「停用策略」逻辑**
   - 目标：在组合回测代码中，真正实现基于回撤的停用逻辑；
   - 任务内容：
     - 实现前述 `state_i` 和 `pos_factor_i` 的逻辑；
     - 输出「带风控前后」两条组合资金曲线和指标对比。

4. **任务 3-2-4：撰写风控效果小结**
   - 目标：用文字总结风控带来的变化；
   - 任务内容：
     - 对比无风控 vs 有风控：
       - 最大回撤、年化收益、Sharpe；
     - 写下你的直觉评价：这套规则是否过于保守或过于激进？

---

### 8. 常见坑与自查清单

1. **用「未来最大回撤」来设阈值**：
   - 例如在全样本回测后，用全样本的最坏回撤来调规则，再回头说「规则有效」。
   - 更合理的做法是：
     - 用前一部分样本（样本内）来粗定规则；
     - 在后一部分样本（样本外）检验规则是否仍然合理。

2. **规则过多、过细**：
   - 一上来设计了很多层级、很多 if/else；
   - 结果你自己都记不住每条规则的含义，也很难调试。
   - 建议：
     - 先从「两级阈值 + 简单行为」开始；
     - 等有实测体验再慢慢增加复杂度。

3. **只停用策略，不复盘原因**：
   - 暂停策略是手段，不是目的；
   - 每次达到停用阈值时，都应该在笔记里写一段复盘：
     - 是市场环境改变导致策略失效？
     - 还是实现/参数有明显问题？

4. **组合层规则与资金管理脱节**：
   - 组合层明明触发了严重回撤，但仓位模板并未降档；
   - 会导致「形式上减仓，实盘上依然激进」。

---

### 9. 小结与下一步

**这一块我已经搞清楚了什么？**

- 回撤、最大回撤、回撤持续时间的含义；
- 单笔止损、单策略回撤控制、组合层回撤控制三层风控的逻辑；
- 如何给每个策略和整个组合设定 warn/stop 阈值，并翻译成伪代码；
- 如何在回测中把这些规则真正执行出来，而不是停留在口头上。

**还有哪些地方暂时没想透？**

- 如何在更严格的统计意义上选取阈值，而不是仅仅凭直觉；
- 如何在多资产、多策略的大组合中设计更细粒度的风险预算；
- 如何处理「回撤触发后，何时可以恢复交易？」这样更动态的问题。

**下一步自然的学习方向：**

1. 基于已有的风控结构，跑一轮「带风控 vs 不带风控」的组合回测，对比结果；
2. 在此基础上进入阶段 3 第 3 块：
   - 把风控输出的「风险档位」与你的资金管理、仓位模板（保守/标准/激进）以及简单 Kelly 结合起来；
   - 真正形成一套「在不同市场状态下我该如何调仓」的规则。
