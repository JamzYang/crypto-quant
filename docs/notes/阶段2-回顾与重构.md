## 阶段 2 第 5 块：回顾与重构学习笔记

### 0. 本块的学习目标（结果导向）

读完并实践完这一块后，我应该能够：

- **梳理** 阶段 2 已实现的策略与模块，并从中挑出值得继续打磨的候选；
- **识别** 当前代码结构中的重复与设计缺陷，提出合理的重构思路；
- **实现** 至少一个「参数敏感性小测试」脚本，并会读它输出的表格；
- **写出** 一份面向阶段 3 的小结：哪些策略值得纳入组合，哪些更适合做风险模块或基准线。


### 1. 本学习块在整体计划中的位置

- 阶段 2 前四块更多是「从 0 到 1」：
  - 搭建趋势、均值回归、波动率调仓等基本轮子；
  - 初步体验样本内/样本外验证与综合对比。
- 第 5 块是一个有意识的「减速带」：
  - 不再急着加新花样，而是回头看：
    - 哪些代码需要整理？
    - 哪些策略参数可能只是凑巧？
    - 哪些想法值得带进阶段 3？


### 2. 阶段 2 策略与模块小盘点

**策略与模块列表**：

- 简单持有 (buy_and_hold) —— 作为最朴素的基准线；
- 双均线趋势 (ma_trend) —— 趋势跟随原型；
- 布林带均值回归 (bollinger) —— 均值回归原型；
- 趋势 + 波动率调仓 (trend_vol) —— 风险管理叠加模块；
- 样本内/样本外综合对比脚本 (`bt_comprehensive_IS_OOS.py`)；
- 双均线参数敏感性测试脚本 (`bt_param_sensitivity_ma_trend.py`)。

从综合报告（第 4 块）来看：

- **布林带策略**：是最接近「风格稳定 + 有一定收益」的候选；
- **趋势 + 波动率调仓**：在收益上平平，但风险控制能力较好；
- **简单持有** 与 **双均线趋势**：在当前样本上难言 alpha，更适合作为对比基准和学习样本。


### 3. 代码层面的重构思路

阶段 2 的代码大致形成了三层结构：

- `src/stage2/data/`：数据加载与预处理；
- `src/stage2/strategies/`：策略与模块（趋势、布林带、波动率调仓等）；
- `src/stage2/backtests/`：具体回测脚本（单标的双均线、布林带、趋势+波动率、综合 IS/OOS、参数敏感性等）。

在这之中，可重构点主要是：

- **重复的绩效评估逻辑**：
  - `compute_performance_stats` 已经成为共用函数，但最初只放在 `bt_ma_trend_single_symbol.py` 中；
  - 未来可以考虑提取到一个专门的 `metrics.py` 或 `utils_backtest.py` 中。

- **重复的数据加载代码**：
  - 好消息是已经抽成了 `load_ohlcv_csv` 与 `add_return_columns`，后续脚本尽量复用；

- **策略与回测职责边界**：
  - 策略类只负责生成信号 / 仓位序列；
  - 回测脚本负责：套用策略、组成资金曲线、计算指标、打印/画图；
  - 这条边界目前已基本形成，后续扩展可以继续沿用。


### 4. 双均线参数敏感性测试设计

在第 5 块中，我先对「双均线趋势策略」做了一个最小版参数敏感性测试：

- **脚本**：`src/stage2/backtests/bt_param_sensitivity_ma_trend.py`
- **核心函数**：
  - `run_ma_param_grid(...)`：
    - 输入：
      - `short_windows`: 短期均线候选列表（如 [10, 20, 30]）；
      - `long_windows`: 长期均线候选列表（如 [50, 60, 90]）；
      - `min_gap`: 最小长短均线间隔；
    - 对每一组 (short, long) 组合：
      - 调用 `run_ma_trend_backtest(...)`；
      - 记录总收益、年化收益、年化波动、Sharpe、最大回撤；
    - 将结果整理为 DataFrame，并按 Sharpe 从高到低排序返回。
  - `print_param_grid_table(df_res)`：
    - 以简洁文本表格形式打印各参数组合表现。

- **默认网格**：
  - 短期：10, 20, 30；
  - 长期：50, 60, 90；
  - `min_gap=5`，避免短期过于贴近长期。


### 5. 参数敏感性测试的启发

从这类小规模测试中，我会刻意关注：

- **Sharpe 的排序是否非常敏感**：
  - 若稍微改动窗口就从 Sharpe>1 掉到 <0，则很可能存在过度依赖某段样本的情况；
- **最大回撤与年化收益的 trade-off**：
  - 有时长一点的长期均线会带来更平滑的资金曲线，但也可能错失一部分收益；
- **是否存在一片「参数平原」**：
  - 若在一片相邻的参数区域内表现都还算可以，则策略的鲁棒性相对更好；
  - 相反，如果只有极少数几个点特别好，其他都很差，则更值得警惕过拟合。

在当前样本上，双均线本身整体表现偏弱，即便某些参数组合略好，也更像是「练习如何做参数敏感性分析」的范例，而不是要立刻投入真金白银的策略。


### 6. 从「修代码」到「修心态」

在这一块，我除了动手重构和加脚本，还特别反思了几件事：

- **不要被一两张好看的曲线冲昏头**：
  - 一张惊艳的 IS 资金曲线，如果在 OOS 立刻崩塌，说明它更像一段「历史故事」，而不是「可重复的交易机制」。

- **策略要有明确角色定位**：
  - 简单持有：Beta 基准；
  - 双均线：趋势世界观练习样本；
  - 布林带：阶段 2 当前样本下最具潜力的单策略候选；
  - 趋势 + 波动率调仓：风险管理 overlay，而非独立 alpha 源。

- **重构不是为了「好看」而是为了「可扩展」**：
  - 把公共逻辑抽出来，是为了之后可以轻松添加更多策略，而不是为了追求形式上的完美结构。


### 7. 面向阶段 3 的准备

结合第 4 块综合报告与第 5 块重构工作，我对阶段 3 的准备大致是：

- **策略层面的准备**：
  - 重点延展布林带均值回归策略（不同参数、不同时间段、不同标的）；
  - 在其上叠加波动率调仓，构造「风险更可控」的版本；
  - 将双均线策略保留为对比基线和教学样本，不急于在真实环境中使用。

- **代码层面的准备**：
  - 保持「数据/策略/回测」三层分离，后续新增策略时只需添加新的策略类和回测脚本；
  - 逐步将评估与工具函数抽到通用模块中，减少拷贝粘贴。

- **心态层面的准备**：
  - 接受「很多想法只在纸面上好看」这一现实；
  - 把 IS/OOS、参数敏感性、回撤等一系列检查，当作每个新策略都必须走一遍的「体检流程」，而不是可选项。

这也算是阶段 2 最重要的一点收获：

> 从「写出第一个能跑的策略」过渡到「会系统地怀疑和检验自己的策略」。
