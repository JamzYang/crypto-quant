# Week4 时间序列基础 + 策略特征准备 学习笔记

> 面向对象：Java 后端、数学基础偏弱的工程师。
>
> 本周目标：
> - 理解 **自相关（autocorrelation）** 和 **滞后（lag）** 的直觉含义；
> - 理解 **平稳性（stationarity）** 和 **差分（differencing）**，知道为什么价格常常需要转换成收益率/差分来建模；
> - 了解 ADF 检验（可选进阶）的工程意义；
> - 学会为策略构建“特征表”，并整理绩效指标函数，为后续双均线回测做准备。

---

## 1. 本周理论大图

### 1.1 时间序列视角在讲什么？

- **自相关**：当前值与过去值的相关性；
- **滞后**：把序列向前/向后平移若干期形成的新序列；
- **平稳性**：统计特征（均值、方差、自相关结构）随时间大致不变；
- **差分**：用相邻值之差构造新序列，削弱趋势，使序列更接近平稳。

### 1.2 策略工程视角在讲什么？

- 为策略准备一个可直接回测的 **特征 DataFrame**：
  - 日期索引；
  - 收盘价、收益率；
  - 均线、滚动波动率等技术指标；
  - 方便在其上生成信号并进行回测。

- 将绩效指标函数（收益率、波动率、回撤、夏普等）整理成统一的工具，
  为后续各种策略提供统一的“体检框架”。

---

## 2. 自相关与滞后：今天和昨天的关系有多大？

### 2.1 自相关的数学思想（工程版）

- 普通相关系数衡量两个不同序列 x_t 和 y_t 在同一时间 t 上的线性关系；
- **自相关**是：
  - 衡量同一个序列在不同时间点之间的线性关系；
  - 例如收益率在 t 时刻与 t-1 时刻、t-5 时刻的相关性。

- 形式上，可以理解为：
  - 取同一序列，拷贝一份往后平移 k 期，与原序列做相关系数；
  - 这个相关系数就是“lag = k 的自相关”。

### 2.2 滞后的直观理解

- 假设有一个价格序列 p_t：
  - 滞后 1 期：p_{t-1}；
  - 滞后 5 期：p_{t-5}；
  - 用这些滞后值可以构造很多“过去的信息特征”。

- 直观上：
  - 如果“今天的收益率与昨天的收益率高度相关”，
    那么昨天的收益率就对今天有一定预测价值。

### 2.3 对交易的意义

- 如果收益率在某些滞后下自相关显著：
  - 说明市场存在某种“可预测结构”；
  - 可以考虑构造简单的动量/反转信号。

- 如果收益率自相关基本为 0：
  - 说明短期线性可预测性较弱；
  - 但还可能存在非线性结构或在更长周期上的自相关。

- 价格 vs 收益率：
  - 价格通常是非平稳且高度自相关（今天价格和昨天价格通常很接近）；
  - 收益率自相关可能更弱，更适合做很多统计建模。

---

## 3. 平稳性与差分：为什么喜欢“稳定”的序列？

### 3.1 平稳序列的数学思想

- 平稳性粗略来说就是：
  - 序列的“统计特征”不会随时间大幅变化；
  - 例如均值、方差、自相关结构大致稳定。

- 非平稳序列往往具有：
  - 明显趋势（长期向上/向下）；
  - 方差随时间变化（早期波动小，后期波动大）；
  - 自相关结构变化明显。

### 3.2 直观理解

- 把价格画出来：
  - 长期整体向上，波动范围越来越大，通常是非平稳；
  - 直接用这种价格序列做回归或建模，很多统计假设都容易被破坏。

- 把收益率或差分画出来：
  - 均值大致在 0 附近左右小幅震荡；
  - 波动大小比较稳定；
  - 更接近平稳序列，更适合做统计推断和建模。

### 3.3 差分（differencing）的作用

- 差分：
  - 一阶差分：d_t = p_t - p_{t-1}；
  - 实际上和简单收益率非常接近（忽略比例缩放）；
  - 直观上就是“看变化而不是看绝对值”。

- 作用：
  - 去除部分趋势；
  - 让序列在均值附近震荡，有助于接近平稳。

### 3.4 对交易的意义

- 大部分时间序列模型（包括 AR 类模型）都假设数据是平稳的：
  - 用价格直接建模往往不合适；
  - 用收益率或差分序列更合理。

- 从策略角度：
  - 很多策略的信号其实是基于“变化”（收益率、价差）而不是价位本身；
  - 比如均线策略看的是“最近 N 天平均价相对当前价”的关系，本质上也是在看趋势/变化。

---

## 4. ADF 检验（可选进阶）：检验是否存在单位根

### 4.1 数学思想（简化版）

- ADF（Augmented Dickey-Fuller）检验：
  - 本质是在检验：序列是否有“单位根”；
  - 有单位根 ≈ 非平稳；
  - 无单位根 ≈ 平稳或接近平稳。

- 检验结果：
  - 给出检验统计量和 p-value；
  - 若 p-value 足够小（比如 < 0.05），通常可以认为“拒绝存在单位根”的假设，
    即倾向于认为序列是平稳的；
  - 若 p-value 较大，则无法拒绝“存在单位根”（非平稳）假设。

### 4.2 直观理解

- 你不需要深究推导，只需知道：
  - 价格做 ADF 往往 p-value 较大 → 非平稳；
  - 收益率或差分后的序列 p-value 较小 → 更接近平稳。

### 4.3 对交易的意义

- ADF 是一个辅助工具：
  - 帮你判断“直接拿这个序列建模是否合适”；
  - 帮你决定是否需要差分或转换成收益率。

- 即使不做 ADF：
  - 你也可以通过图形、滚动均值/方差等直观方法判断平稳性；
  - 工程上，两者是互补关系。

---

## 5. 构建策略特征表：从原始 K 线到可回测数据集

### 5.1 特征表的概念

- 对于一个策略来说，理想的数据结构是：
  - 一个以日期为索引的 `DataFrame`；
  - 列中包含：价格、收益率、技术指标、信号、持仓等；
  - 回测时只需要在这个表上迭代，按列计算策略表现。

### 5.2 第 4 周建议的特征表字段

- 典型字段包括：
  - `close`：收盘价；
  - `log_ret`：对数收益率；
  - `ma_short` / `ma_long`：短期/长期均线（例如 5 日/20 日）；
  - `vol_rolling`：滚动波动率（例如 20 日收益率标准差）；
  - 以及未来会加入的：信号、持仓、策略收益等。

### 5.3 工程意义

- 统一特征表：
  - 让你能在同一套数据结构上迭代不同策略；
  - 降低策略之间的“粘连度”，便于维护和扩展。

- 从原始 K 线到特征表的流程：
  1. 读取原始 CSV（或 API 数据），统一字段名与时区；
  2. 设置日期索引，按时间排序；
  3. 计算收益率、均线、滚动波动率等特征；
  4. 丢弃前期缺失值（例如均线计算前的空值）；
  5. 保存为新的 CSV，供后续多次复用。

---

## 6. 绩效指标函数整理：做一套“通用体检工具”

### 6.1 为什么要统一绩效函数？

- 在第 2 周你已经学习了：
  - 累计收益率、年化收益率、年化波动率、最大回撤、夏普比率等；
- 本周的重点是：
  - 把这些零散公式整合成一组统一的函数；
  - 在任意策略回测后，调用同一套函数生成“绩效报告”。

### 6.2 统一接口的好处

- 对策略开发者：
  - 每写一个新策略，只需要输出每日策略收益序列；
  - 绩效函数负责给出最终的年化收益、波动率、回撤、夏普等。

- 对代码维护：
  - 需要修改计算方法时（例如更精细地处理年化、交易日数），
    只要改函数内部即可，全局策略评估逻辑保持不变。

### 6.3 与双均线项目的关系

- 在后续双均线回测项目中：
  - 你会用特征表生成买卖信号和持仓；
  - 计算每日策略收益与资金曲线；
  - 用这套绩效函数对策略做完整的“体检”；
  - 与简单持有策略做对比分析。

---

## 7. 第 4 周理论如何串到双均线回测项目

### 7.1 数据与特征

- 使用第 4 周中构建好的特征表：
  - 包含价格、收益率、短长均线、滚动波动率等；
  - 这是策略信号计算的直接输入。

### 7.2 信号生成与回测

- 信号生成：
  - 例如：短均线向上突破长均线 → 持有（signal=1）；
  - 短均线向下跌破长均线 → 空仓（signal=0）。

- 回测循环：
  - 用 signal 决定每日是否持仓；
  - 计算策略每日收益与资金曲线；
  - 同时计算“简单持有”曲线作为基准。

### 7.3 绩效评估与可视化

- 绩效评估：
  - 使用统一绩效函数得到收益、波动、回撤、夏普等；
- 可视化：
  - 策略 vs 持有的资金曲线；
  - 策略回撤曲线；
  - 可在图形中直观看到策略在哪些阶段优于持有、在哪些阶段表现更差。

---

## 8. 学完本周理论后，你应该能做到

- **用自己的话解释**：
  - 自相关、滞后分别是什么，它们在时间序列中的含义；
  - 平稳性的大致概念，为什么价格通常非平稳而收益率更接近平稳；
  - 为什么差分/收益率是构建时间序列模型和策略信号的常用基础；
  - ADF 检验在工程上大致是用来干什么的。

- **在工程实践中完成**：
  - 使用 pandas 计算不同滞后下的自相关，画简单 ACF 图；
  - 对价格、收益率、差分序列做可视化和简单统计对比；
  - 构建包含价格、收益率、均线、滚动波动率等字段的特征表；
  - 使用一套统一绩效函数，对任意策略的每日收益序列生成绩效报告。

当你能把“自相关 + 平稳性 + 特征表 + 绩效函数”这条线串起来，并为双均线策略准备好完整的数据和评估框架时，第四周的理论目标就已经达成了。
