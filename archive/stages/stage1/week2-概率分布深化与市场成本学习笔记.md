# Week2 概率分布深化 + 多币种波动率与交易成本 学习笔记

> 面向对象：Java 后端、数学基础较弱的工程师。
>
> 本周目标：
> - 用“工程师视角”继续加深对大数定律 & 中心极限定理的理解，体会不同分布的差异；
> - 理解“多币种波动率”的含义与比较方法；
> - 建立对现货 / 合约、杠杆、手续费、滑点、资金费率的直觉认识；
> - 理解基本绩效指标（累计收益率、年化收益率、波动率、最大回撤、夏普）。

---

## 1. 本周理论大图

### 1.1 数学与统计思想在讲什么？

- **大数定律 & 中心极限定理（更工程化）**
  - 不同分布（均匀、重尾等）在“样本均值收敛”方面表现不同；
  - 即便分布本身不是正态，很多情况下“和/平均值”依然趋向正态，但收敛速度、尾部行为不同。

- **波动率（Volatility）与多资产比较**
  - 对同一时间区间，不同币种的波动率可以差很多；
  - 波动率是一种“风险强度”的度量，用来对比资产“有多暴躁”。

- **绩效指标**
  - 累计收益率、年化收益率、年化波动率；
  - 最大回撤（能亏多深）；
  - 夏普比率（单位风险带来多少超额收益）。

### 1.2 市场与工程实践在讲什么？

- **交易类型与成本结构**
  - 现货 vs 合约（永续、交割）；
  - 杠杆与保证金：放大收益也放大风险；
  - 手续费、滑点、资金费率共同组成交易成本；
  - 不同频率、不同品种的交易，成本结构截然不同。

- **代码与函数封装**
  - 将“收益率计算、波动率计算、绩效评价”做成通用函数；
  - 为后续策略回测复用，减少重复代码和出错概率。

---

## 2. 大数定律 & 中心极限定理深化

### 2.1 回顾：第 1 周你已经知道什么？

- **大数定律**：
  - 同样的随机试验重复很多次，样本均值会越来越接近真实均值；
  - 直观例子：抛硬币次数越多，“正面比例”越稳定。

- **中心极限定理**：
  - 很多独立随机变量的和/平均值，哪怕单个分布不是正态，它们的和/均值也会趋向正态；
  - 直观例子：多天收益率的累积收益更接近正态。

### 2.2 新增视角：不同分布下的“收敛速度”

#### 数学思想（工程版）

- 不同的基础分布（比如均匀分布、重尾分布），
  - 虽然都可能满足大数定律和中心极限定理，
  - 但“样本均值变稳定的速度”和“接近正态的程度”会不一样。

- 均匀分布：
  - 每个结果出现的概率差不多；
  - 极端值不多；
  - 样本均值收敛相对平滑。

- 重尾分布：
  - 极端值出现概率更高；
  - 少数极端值会严重拉动均值；
  - 需要更多样本才能看起来“相对稳定”。

#### 直观理解

- 你会在 Day 29 做的模拟：
  - 用 NumPy 生成不同分布的样本，分多次取平均；
  - 画出样本均值的直方图或者 QQ 图：
    - 均匀分布的样本均值更容易看起来像正态；
    - 重尾分布的样本均值可能需要更多样本、或者尾部仍然比正态更粗。

#### 对交易的意义

- 如果资产收益率本身是“重尾”的：
  - 即便你“交易很多次”，平均收益率仍会受到少数极端事件的强烈影响；
  - 大数定律并不意味着“做得越久收益率一定稳定”，尤其在极端风险频繁的市场。

- 在策略评估中：
  - 不能只看“样本数量多就放心”；
  - 要关注：
    - 数据是否包含多轮牛熊；
    - 是否包含极端行情；
    - 收益率分布是否明显重尾。

---

## 3. 多币种波动率：谁更“暴躁”？

### 3.1 波动率的工程理解

- 波动率本质上是：
  - 收益率的波动有多大，用标准差来度量；
  - 单位可以是“日波动率”、“年化波动率”等。

- 日波动率 vs 年化波动率：
  - 日波动率：
    - 例如每日收益率标准差为 2%；
  - 年化波动率（简化工程版）：
    - 假设一年 252 个交易日，年化波动率 ≈ 日波动率 × √252。

> 注意：上面的年化公式依赖“独立同分布、中心极限定理”等假设，在有自相关、波动聚集的真实市场中只是近似，但对工程实践仍然非常常用。

### 3.2 多币种波动率对比的数学思想

- 对不同币种（BTC、ETH、其它主流币）：
  - 在统一时间区间内，计算它们的日收益率；
  - 计算每个币种的年化波动率；
  - 画出各自的收益率分布，直观比较“谁波动更大”。

- 这样做实质是在回答：
  - “这几个资产，谁更‘暴躁’？”
  - “它们的风险强度在一个量级上，还是差很多？”

### 3.3 直观理解

- 假设结果是：
  - BTC 日收益率波动率 ≈ 3%；
  - ETH 日收益率波动率 ≈ 4%；
  - 某小币种日收益率波动率 ≈ 8%。

- 对你来说，这意味着：
  - 用同样的仓位，小币种账户曲线会更“锯齿”；
  - 高波动不意味着一定更赚钱，只是涨跌幅更大。

### 3.4 对交易的意义

- **仓位管理**：
  - 同样是 1 万 USDT 仓位，放在高波动币种上的“心理压力”更大；
  - 实务上会根据波动率调仓位（例如用目标波动率方法）。

- **策略比较**：
  - 对不同币种应用同一个策略，要用“收益/波动”一起比较；
  - 仅看收益可能会误判一个“高风险高收益”的币种为“更好”。

Day 30 让你做的，就是把这些概念变成“看得见的表和图”。

---

## 4. 交易类型与成本结构

### 4.1 现货 vs 合约：本质差异

#### 现货

- 直接买卖资产本身（比如买 BTC）；
- 没有杠杆（或者杠杆较低，如简单借币）；
- 不太会有强平的概念（除非你借了钱）。

#### 合约（永续 / 交割）

- 交易的是“合约”，而不是币本身；
- 通常可以开高杠杆（例如 5 倍、10 倍甚至更多）；
- 有保证金制度：
  - 你只需要拿出部分资金作为保证金；
  - 一旦亏损过多，保证金不足，会触发强平。

### 4.2 杠杆与保证金的数学思想

- 杠杆倍数 = 持仓名义价值 / 自有资金。

- 举例：
  - 你有 1000 USDT，自有资金 = 1000；
  - 开 5 倍杠杆多单，名义仓位 = 5000 USDT；
  - 如果价格上涨 10%，你的名义盈利 = 500（10% × 5000），
    - 换算成自有资金收益率 = 500 / 1000 = 50%；
  - 如果价格下跌 10%，亏损同样放大为 50%。

- 直观结论：
  - 杠杆放大的是**收益率的波动**，包括上涨和下跌；
  - 高杠杆 = 高波动 = 更容易爆仓。

### 4.3 手续费、滑点、资金费率：看不见的“摩擦”

#### 手续费

- 每次交易都要支付一定比例的手续费，如 0.1%、0.04% 等；
- 对频繁交易策略影响巨大，对长线持仓影响相对较小。

#### 滑点

- 你想买的价格和实际成交价格之间的差异；
- 通常在：
  - 你下单量较大；
  - 市场深度较浅；
  - 波动剧烈的时刻，滑点会变大。

#### 资金费率（永续合约）

- 为了让合约价格靠近现货价格，交易所设计的融资机制；
- 多空双方定期互相支付资金费率：
  - 合约价格高于现货：多头付费给空头；
  - 合约价格低于现货：空头付费给多头；
- 对长期持仓的成本影响非常明显。

### 4.4 对交易的意义

- Day 31 里的“简单计算”让你做的是：
  - 对比同一笔交易在现货和合约上的综合成本；
  - 感受：
    - 频繁开平仓的合约策略，在手续费 + 滑点 + 资金费率下，可能需要更高的“毛收益”才能打平成本；
    - 长期持仓现货，主要成本可能集中在买入/卖出瞬间的手续费和滑点。

- 工程视角：
  - 任何策略回测，如果完全不考虑手续费和滑点，很可能严重高估真实收益；
  - 对合约策略，还要额外考虑资金费率的长期影响。

---

## 5. 收益率与波动率函数封装的工程意义

### 5.1 为什么要封装成函数？

- 你会在很多地方反复做：
  - 从价格算收益率；
  - 从收益率算波动率；
  - 对不同币种、不同周期重复同样的操作。

- 如果每次都手写一堆 `df['ret'] = ...`、`std()`、`sqrt(252)`：
  - 容易写错；
  - 不利于统一修改（例如之后你想统一改收益率定义）。

### 5.2 把公式变成“接口”的思想

- Day 32 建议你写：
  - `calc_returns(df)`：
    - 输入：价格序列；
    - 输出：包含简单收益率和对数收益率的 DataFrame；
  - `calc_annual_vol(returns, freq=252)`：
    - 输入：日度收益率；
    - 输出：年化波动率。

- 工程意义：
  - 上层策略、回测代码只关注“调用接口”，不用每次再想公式细节；
  - 若之后改动计算方法，只要改函数内部，实现统一升级。

---

## 6. 绩效指标：如何评价一个策略/资产？

### 6.1 累计收益率

- 概念：
  - 从起始点到当前的整体涨跌幅度；
  - 直观上是“如果我从头持有到现在，一共赚了多少”。

- 工程计算（直觉版）：
  - 若你有每日收益率序列 `r_t`，
  - 累计收益率 ≈ (1 + r_1) × (1 + r_2) × ... × (1 + r_n) - 1。

### 6.2 年化收益率

- 概念：
  - 把“从起点到终点的总收益”折算成“每年平均收益率”；
  - 方便对比不同时间长度的策略或资产。

- 简化工程思路：
  - 先求总收益率，再根据持有天数换算到“每年”水平；
  - 具体公式可在函数里实现，不必硬记，但要理解含义：
    - 不同持有时长的收益要可比，就需要年化。

### 6.3 年化波动率

- 概念：
  - 把收益率的波动强度换算到“每年”的尺度；
  - 常用来描述风险强度。

- 工程近似：
  - 年化波动率 ≈ 日收益率标准差 × √252。

### 6.4 最大回撤

- 概念：
  - 账户从历史最高点跌到后面某个低点的 **最大跌幅**；
  - 本质问题：
    - “历史上最难熬的一段，亏了多少？”

- 直观意义：
  - 如果一个策略最终收益很高，但中间有 -70% 的回撤，大多数人心理上扛不住；
  - 最大回撤是“心理压力”和“资金安全”的关键指标。

### 6.5 夏普比率

- 核心思想：
  - 用“单位波动率带来的平均超额收益”评价策略；
  - 简化版（无风险利率约为 0）：
    - 夏普 ≈ 年化收益率 / 年化波动率。

- 直观理解：
  - 年化收益率 20%，年化波动率 10% → 夏普 ≈ 2；
  - 年化收益率 20%，年化波动率 40% → 夏普 ≈ 0.5；
  - 前者“同样收益、风险更小”，质量更高。

### 6.6 对交易的意义

- 单看收益率不够：
  - 高收益往往伴随高波动；
  - 你需要把“收益”和“风险”一起看。

- 绩效指标的组合：
  - 累计 & 年化收益率：你赚了多少；
  - 年化波动率：你为此承担多大波动；
  - 最大回撤：历史最惨可以多惨；
  - 夏普：每单位风险带来多少收益。

Day 33 让你把这些概念通过代码算出来，对某个简单持有策略做完整的“体检报告”。

---

## 7. 本周理论如何串到周末迷你项目？

### 7.1 Day 29：不同分布下的大数定律 & 中心极限定理

- 通过模拟：
  - 均匀分布 vs 重尾分布的样本均值收敛行为；
  - 感受：有的分布下，均值很快稳定；有的分布下，极端值长期干扰均值。

- 对应理解：
  - 现实市场更接近哪种分布？
  - 为什么“重尾”市场中，平均收益率不一定可靠？

### 7.2 Day 30：多币种波动率与收益率对比

- 你会在同一时间段上：
  - 计算多个币种的日收益率与年化波动率；
  - 画收益率分布对比图；
  - 找出波动率最高、最低的币种。

- 对应理解：
  - 波动率是风险强度，不是“收益保证”；
  - 不同币种的风险特征差异巨大，策略与仓位不能一刀切。

### 7.3 Day 31：交易类型与成本的数字感

- 你会用具体数字算：
  - 单次现货交易的手续费成本占比；
  - 使用杠杆合约后的开平仓成本、资金费率影响。

- 对应理解：
  - 高频交易在实际市场中需要付出什么级别的“摩擦成本”；
  - 长期持仓时，哪些成本是主要矛盾。

### 7.4 Day 32–33：封装函数 + 完整绩效分析

- Day 32：把收益率、波动率等计算封装成函数，形成“工具库”；
- Day 33：利用函数对简单持有策略做绩效分析（收益率、波动率、最大回撤、夏普）。

- 对应理解：
  - 把数学公式落实为可复用代码接口；
  - 建立一套通用绩效评价框架，为后续所有策略服务。

### 7.5 周末迷你项目：多币种波动率 & 成本对比

- 项目目标：
  - 对比 3–4 个主流币的年化波动率、最大回撤、假设交易成本等；
  - 用表格 + 图形展示；
  - 写出分析：哪些币种更适合趋势策略，高频交易成本压力有多大。

- 理论串联：
  - 大数定律、中心极限定理 → 理解样本与波动的关系；
  - 波动率 → 风险强度；
  - 交易成本 → 把“纸面收益”打折成“实际收益”；
  - 绩效指标 → 系统地衡量策略质量。

---

## 8. 学完本周理论后，你应该能做到

- **用自己的话解释**：
  - 为什么不同分布下，大数定律和中心极限定理的“表现”不一样；
  - 什么是年化波动率，它和风险有什么关系；
  - 现货与合约的本质差异，杠杆如何放大收益和风险；
  - 手续费、滑点、资金费率如何共同侵蚀策略收益；
  - 累计收益率、年化收益率、最大回撤、夏普分别在描述什么。

- **能在代码中实现**：
  - 对多个币种的日线数据统一处理，计算收益率和年化波动率；
  - 使用封装函数生成“绩效摘要”（收益、波动、回撤、夏普）；
  - 在项目中比较不同币种、不同策略的综合表现，而不只是看“收益字面值”。

当你能把这些理论用日常语言讲给一个完全不懂金融的同事听，并用 pandas + NumPy 把对应的指标算出来时，第二周的理论目标就已经基本达成了。
