# Week3 线性回归 + 相关性 + 市场微观结构 学习笔记

> 面向对象：Java 后端、数学基础偏弱的工程师。
>
> 本周目标：
> - 建立对 **线性回归** 的工程直觉：最小二乘法、斜率、截距、R²、残差；
> - 理解如何用回归分析 ETH 对 BTC 的价格关系，以及这种关系为什么可能不稳定；
> - 初步认识 **市场微观结构**：订单簿、价差、深度与流动性；
> - 理解交易所 API / 历史数据在量化研究中的角色，为后续回测和实盘做准备。

---

## 1. 本周理论大图

### 1.1 数学与统计思想在讲什么？

- **线性回归**（Linear Regression）：
  - 给一堆 (x, y) 数据点，找一条“尽量贴近这些点”的直线；
  - 用最小二乘法（least squares）度量“贴近”——让误差平方和最小；
  - 用 R² 衡量“这条线能解释多少 y 的波动”。

- **相关性与回归关系**：
  - 相关系数刻画两个变量“线性同步”的程度；
  - 回归把这种关系形式化为：y ≈ a + b·x；
  - 回归关系可能随时间变化，不是“定死的规律”。

### 1.2 市场与工程实践在讲什么？

- **ETH 对 BTC 的回归与残差分析**：
  - 把 BTC 价格当自变量，ETH 价格当因变量；
  - 看二者的线性关系：ETH 是否可以被 BTC 部分“解释”？
  - 残差代表“超出线性关系的部分”，是做相对价值策略的基础思想之一。

- **市场微观结构**：
  - 订单簿、买一卖一价差（spread）、市场深度、流动性；
  - 这些因素决定：你的订单能否以理想价格成交、会不会产生较大滑点。

- **API 与数据准备**：
  - 学会把交易所/API 视为“数据源”；
  - 知道如何把原始 K 线下载为 CSV，并整理成 pandas 可用的格式。

---

## 2. 线性回归直觉：用一条线拟合一堆点

### 2.1 数学思想（工程版）

- 问题：给定一堆点 (x_i, y_i)，怎样找一条直线 y = a + b·x，
  让“直线上的 y 与真实 y 的差”整体最小？

- 最小二乘法的核心思路：
  - 定义误差：e_i = y_i - (a + b·x_i)；
  - 定义目标：最小化 Σ e_i²（所有误差的平方和）；
  - 通过求导或线性代数解出 a、b 的解析式。

- 几何直觉：
  - 把每个点到直线的“竖直距离”看成误差；
  - 最小二乘法就是“找一条让这些竖直距离平方和最小的线”。

### 2.2 直观理解

- 如果你画出散点图：
  - 点大致沿着一条斜线分布，说明存在明显线性关系；
  - 点比较散乱，则线性关系较弱。

- 斜率 b 的含义：
  - b > 0：x 增大，y 倾向于增大（正相关）；
  - b < 0：x 增大，y 倾向于减小（负相关）；
  - |b| 大：y 对 x 很敏感；|b| 小：y 对 x 不敏感。

- 截距 a 的含义：
  - x = 0 时，直线给出的 y 值；
  - 在价格这种场景下，本身未必有很直观的经济意义，更关注 b 和整体拟合效果。

### 2.3 R²（决定系数）与残差

- R²：
  - 介于 0 和 1 之间；
  - 直觉上：这条回归线解释了多少比例的 y 波动；
  - R² 越高，说明线性模型“解释度”越强。

- 残差（residual）：
  - 残差 = 实际值 - 拟合值；
  - 表示“这一天的 y，比线性关系多了多少 / 少了多少”。

- 对回归质量的直觉判断：
  - 残差应该大致“零均值、无明显趋势”；
  - 若残差本身有趋势或结构，说明线性模型还不够好。

### 2.4 对交易的意义

- 回归是一种“用简单结构解释复杂价格关系”的工具：
  - b 可以看成某种“贝塔”（beta），即一资产对另一资产的敏感度；
  - R² 高，说明这个资产的波动大部分可以用另一个资产来解释；
  - 残差可以被视为“超额表现”或“相对价差”。

- 在量化中：
  - 有人用回归残差构造“均值回复”或“配对交易”策略；
  - 但前提是：回归关系相对稳定，否则残差本身也会漂移失效。

---

## 3. ETH 对 BTC 的回归：把相关性变成公式

### 3.1 数学思想

- 设：
  - x_t = BTC 在 t 日的价格；
  - y_t = ETH 在 t 日的价格；
  - 对齐相同日期后，做回归：y_t ≈ a + b·x_t。

- 回归结果：
  - b：ETH 相对 BTC 的“敏感度”；
  - a：基准价差（在 x=0 时候的理论 y，实际经济意义有限）；
  - 残差：真实 ETH 价格和这条线的偏离。

### 3.2 直观理解

- 如果 b ≈ 10：
  - 可以粗略理解为“ETH 价格大约是 BTC 的 10 倍”，当然只是线性近似；
  - 当 BTC 上涨 1%，ETH 理论上也会有大致相似的变化（在相同时间段内）。

- 残差序列：
  - 残差为正：当日 ETH “比模型预测的贵”，可能是相对高估；
  - 残差为负：当日 ETH “比模型预测的便宜”，可能是相对低估；
  - 如果残差呈现出均值附近波动，可以尝试从中寻找“均值回复”的机会。

### 3.3 对交易的意义与风险

- 意义：
  - 回归帮助你把“两个资产看起来相关”变成一个可计算的关系；
  - 残差可以作为相对价值策略（如配对交易）的信号来源之一。

- 风险：
  - 回归关系可能随时间改变（例如市场结构变化、叙事改变）；
  - 如果你假设 b 是稳定的，但实际上 b 在慢慢漂移，策略很容易在 regime 变化时失效；
  - 因此要关注“回归结果在不同时间子区间的稳定性”。

---

## 4. 回归稳定性与子样本分析

### 4.1 数学思想

- 在不同时间段做回归：
  - 把整个样本分成前半 / 后半、或按年份、按周期分段；
  - 在每个子样本上分别估计 a、b 和 R²；
  - 比较它们的差异。

- 如果参数在各段之间差异很大：
  - 说明关系不稳定，模型对未来的预测力有限；
  - 你需要非常小心地使用这种回归关系去做交易决策。

### 4.2 直观理解

- 类比：
  - 某个行业在 2017–2019 可能和大盘高度同步；
  - 但在 2020–2021 可能因某些事件完全走出独立行情；
  - 这时用老的回归关系预测新阶段非常危险。

### 4.3 对交易的意义

- 对 ETH–BTC 关系来说：
  - 不同周期（牛市、熊市、震荡期），它们的联动性可能完全不同；
  - 回归斜率、R² 在不同阶段的变化本身就是一个重要信号：
    - 关系更紧：适合做联动交易；
    - 关系变弱：要减少对该回归模型的依赖。

---

## 5. 市场微观结构：你下的单在订单簿里发生了什么

### 5.1 订单簿与买一卖一价差

#### 数学思想

- 订单簿：
  - 买单（bid）和卖单（ask）按价格和数量排序；
  - 买一价 = 当前最高的买入报价；
  - 卖一价 = 当前最低的卖出报价；
  - 买一卖一之间的差 = 价差（spread）。

#### 直观理解

- 当你市价买入：
  - 实际成交在卖一价或更高的价位上；
  - spread 就是你天然要付出的一部分成本。

- 当市场深度很浅：
  - 你的一笔大单可能“吃掉”多个卖档，平均成交价比预期高很多；
  - 这就是**冲击成本**和滑点的一部分来源。

### 5.2 深度与流动性

#### 数学思想

- 深度：
  - 在某一价格附近，买卖盘挂单的数量；
  - 深度越高，说明市场越能承受大额单子而不引起剧烈价格变化。

- 流动性：
  - 综合考虑深度、成交频率、价差等因素；
  - 高流动性的市场，交易冲击更小、滑点更低。

#### 对交易的意义

- 对于策略设计：
  - 高频、短线策略需要非常关注深度和滑点；
  - 长线策略虽然对单次滑点更不敏感，但大额建仓/平仓时仍然会受影响。

- 对回测：
  - 如果回测完全忽略微观结构，只按“蜡烛线价格”成交，
    会系统性低估真实成交成本。

---

## 6. 交易所 API 与数据准备

### 6.1 API 的角色

- 在量化中，API 是你与交易所“对话”的接口：
  - 获取历史 K 线数据；
  - 获取实时行情与订单簿；
  - 下单、撤单。

- 在学习阶段：
  - 即便暂时不连 API，也要学会从公开数据源下载 CSV；
  - 统一字段命名、时区、频率，方便后续使用。

### 6.2 安全与工程实践

- API Key 的安全：
  - 私密信息只放在本地 `.env`、配置文件或环境变量中；
  - 不要提交到 Git 仓库。 

- 数据管理：
  - 建议使用 `data/` 目录存放原始 CSV；
  - 通过脚本将原始数据转换成标准化格式（统一列名、时区）。

### 6.3 对回测与实盘的意义

- 数据的质量与清洗程度，直接决定：
  - 你对市场统计特征的判断是否可靠；
  - 回测结果的可信度；
  - 实盘中的风控是否有足够“现实基础”。

---

## 7. 本周理论如何串到周末项目：BTC & ETH 关系研究

### 7.1 项目目标

- 用回归与相关性方法，分析 BTC 与 ETH 的价格联动关系：
  - 在不同时间区间计算相关系数；
  - 做回归，比较不同子区间的斜率、截距、R²；
  - 观察关系随时间的变化。

### 7.2 理论串联

- **线性回归**：构建 ETH ~ BTC 的线性模型；
- **相关性**：用相关系数评估联动强度；
- **回归稳定性**：在不同时间子区间比较回归结果；
- **市场微观结构**：帮助你从更细粒度理解两者价格如何在订单簿中形成；
- **API / 数据准备**：为这类分析提供稳定的数据来源。

---

## 8. 学完本周理论后，你应该能做到

- **用自己的话解释**：
  - 什么是线性回归、最小二乘法在直觉上的含义；
  - 斜率、截距、R²、残差分别是什么、代表什么；
  - 为什么 ETH 对 BTC 的回归关系可能随着时间发生明显变化；
  - 订单簿、价差、深度、流动性这些概念是什么意思。

- **在代码中完成**：
  - 使用 `np.polyfit` 等方法拟合简单线性回归；
  - 对 BTC 和 ETH 数据做回归，画出散点图 + 拟合直线；
  - 分多个时间段重复回归，比较参数和 R² 的变化；
  - 使用 API 或 CSV 下载数据，整理到 pandas DataFrame 中用于分析。

当你能把“线性回归 + 相关性 + 市场微观结构”这三个部分各自讲清楚，并能用代码复现计划中的例子时，第三周的理论目标就已经达成了。
