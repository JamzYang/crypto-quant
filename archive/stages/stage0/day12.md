# Day 12 学习笔记 · 风险指标入门

## 1. 今日学习目标

- 理解三个核心风险指标：最大回撤、夏普比率、胜率与盈亏比。
- 用「账户净值变化」的视角，直观理解这些指标在实盘中的意义。
- 能看懂并写出简单的 Python 函数，计算这些指标，为后面的量化策略做准备。

> 思路：先讲 **思想和直觉**，再给一点点 **公式**，最后落到 **代码实现与交易意义**。

---

## 2. 最大回撤（Max Drawdown）

### 2.1 数学思想（用白话说）

先不管公式，最大回撤只回答一个问题：

> 在这段时间里，我的账户从「最高点」跌到「后来最惨的那个谷底」，**最多亏了多少比例？**

关键点：

- 先找出整个净值曲线中，**每个时刻之前出现过的最高点**。
- 对于某一天，比较当前净值 vs 之前历史最高净值，算出「回撤比例」。
- 在所有这些回撤里，**最严重的那一次，就是最大回撤**。

形式化一点，如果：

- \(V_t\)：第 t 天的账户净值
- \(M_t = \max_{0 \le s \le t} V_s\)：到第 t 天为止历史最高净值

那么第 t 天的回撤：

\[
\text{Drawdown}_t = \frac{V_t - M_t}{M_t}
\]

最大回撤：

\[
\text{MaxDrawdown} = \min_t \text{Drawdown}_t
\]

注意：结果一般是一个负数，例如 -0.25，通常会说「最大回撤 25%」。

### 2.2 直观理解：从一条净值曲线看

假设账户从 100 元开始：

1. 涨到 120
2. 跌到 90
3. 再涨到 130

在这段过程中：

- 阶段高点：曾经到过 120
- 最惨位置：跌到 90
- 从 120 跌到 90，跌了 30
- 回撤比例 = 30 / 120 = 0.25 = 25%

哪怕后来涨到了 130，这段「从 120 跌到 90」的 25% 跌幅已经发生过，**最大回撤不会被抹掉**。

### 2.3 对交易的意义

- 最大回撤反映的是策略「最痛的那一次被打脸」。
- 投资人非常关心：
  - 你可以年化赚 30%，但最大回撤 70%，可能没人敢用。
  - 年化 10%，最大回撤 5%，反而很受欢迎。
- 同样收益的策略，最大回撤越小，抗风险能力越强，也更容易扛得住心理压力。

简单记忆：

- 收益看「你能赚多少」。
- 最大回撤看「你愿意为这份收益承受多疼」。

### 2.4 Python 实现示例

这里假设你已经有一列按时间排序的收益率 `returns`（如每日收益），用 pandas 的 Series 表示。

```python
import pandas as pd

def max_drawdown(returns: pd.Series) -> float:
    """计算给定收益率序列的最大回撤。

    参数：
        returns: pandas 的 Series，表示每期收益率，例如 0.01 表示 1% 收益。

    思路：
        1. 根据收益率计算从 1 开始的累计净值曲线。
        2. 计算净值曲线的历史最高值（运行最大值）。
        3. 当前净值相对历史高点的跌幅，就是回撤比例。
        4. 所有回撤中的最小值（最负的那个），就是最大回撤。
    """
    # 1. 根据收益率序列计算净值曲线，从 1 开始
    cumulative = (1 + returns).cumprod()

    # 2. 计算到每个时刻的历史最高净值
    running_max = cumulative.cummax()

    # 3. 计算回撤比例（通常为 0 或负数）
    drawdown = (cumulative - running_max) / running_max

    # 4. 返回最严重的那次回撤
    return float(drawdown.min())
```

可以先用一段很短的 Series 手算对照，比如：

```python
returns = pd.Series([0.1, -0.05, -0.1, 0.2])
```

自己画在纸上，算每一步净值和历史高点，再对比函数输出，有助于加深理解。

---

## 3. 夏普比率（Sharpe Ratio）

### 3.1 数学思想

夏普比率想回答的问题是：

> 在承担单位「波动风险」的前提下，你多赚了多少「超额收益」。

简化版公式（忽略无风险利率时）：

\[
\text{Sharpe} = \frac{E[R]}{\sigma(R)}
\]

- \(E[R]\)：平均收益率（比如日平均收益）。
- \(\sigma(R)\)：收益率的标准差（波动率）。

更一般一点：

\[
\text{Sharpe} = \frac{E[R] - R_f}{\sigma(R)}
\]

- \(R_f\)：无风险利率（如国债利率），短期练习可以认为是 0。

### 3.2 直观理解

- 分子越大：平均收益越高，夏普越好。
- 分母越大：波动越大，在同样收益下夏普会被「稀释」。
- 夏普比率本质上是一个 **收益 / 风险** 的比值，用来比较不同策略的「性价比」。

注意：

- 要在**同一时间尺度上比较**（日收益 vs 日收益，或周收益 vs 周收益）。
- 实务中经常使用「年化夏普」，如果用日收益：

\[
\text{Sharpe}_{\text{annual}} \approx \text{Sharpe}_{\text{daily}} \times \sqrt{252}
\]

其中 252 是一年的大致交易日数量。

### 3.3 对交易的意义

- 夏普高不等于「不亏钱」，而是指「在波动给定的前提下，收益相对更高」。
- 很多量化基金会用夏普作为一个重要考核指标：
  - 夏普 < 1：策略可能比较一般。
  - 1～2：还不错。
  - > 2：很优秀（但也要看是否过拟合）。

### 3.4 Python 实现示例

```python
import numpy as np
import pandas as pd

def sharpe_ratio(returns: pd.Series, risk_free: float = 0.0, periods_per_year: int = 252) -> float:
    """计算给定收益率序列的年化夏普比率。

    参数：
        returns: pandas Series，每期收益率（如日收益）。
        risk_free: 无风险利率的每期收益率，默认 0。
        periods_per_year: 每年的期数，例如日频 252，周频 52。

    思路：
        1. 计算超额收益 R - R_f。
        2. 计算超额收益的平均值和标准差。
        3. 得到每期夏普 = 平均超额收益 / 标准差。
        4. 乘以 sqrt(一年期数) 得到年化夏普。
    """
    excess = returns - risk_free

    mean_excess = excess.mean()
    std_excess = excess.std(ddof=1)

    if std_excess == 0:
        # 没有波动时无法计算夏普，可以返回 0 或 NaN
        return 0.0

    sharpe_per_period = mean_excess / std_excess
    sharpe_annual = sharpe_per_period * np.sqrt(periods_per_year)
    return float(sharpe_annual)
```

可以用随机收益或简单数据测试，体会「波动变大、收益不变时，夏普下降」的效果。

---

## 4. 胜率与盈亏比

### 4.1 基本概念

这里一般是基于「每一笔交易」来统计，而不是每天。

- **胜率（Win Rate）**：

  \[
  \text{Win Rate} = \frac{\text{盈利笔数}}{\text{总交易笔数}}
  \]

- **盈亏比（Payoff Ratio）**：

  \[
  \text{Payoff Ratio} = \frac{\text{平均盈利}}{|\text{平均亏损}|}
  \]

举例：

- 你做了 10 笔交易，其中 4 笔赚钱，6 笔亏钱：
  - 胜率 = 4 / 10 = 40%
- 赚的 4 笔分别是：+10, +8, +12, +9，平均盈利 ≈ 9.75
- 亏的 6 笔分别是：-3, -2, -4, -3, -5, -3，平均亏损 ≈ -3.33
- 盈亏比 ≈ 9.75 / 3.33 ≈ 2.93

虽然胜率只有 40%，但盈亏比很高，整体依然可以赚钱。

### 4.2 对交易的意义

- 很多趋势策略：
  - 胜率不一定高（比如 30%～40%），
  - 但盈亏比高（大赚小亏），整体仍然正收益。
- 很多均值回归策略：
  - 胜率看起来很高（70%～80%），
  - 但一旦行情极端，容易连续暴亏，导致大回撤。

看一个策略时，要同时看：

- 胜率：你多大概率赚钱？
- 盈亏比：赚的时候赚多少，亏的时候亏多少？
- 最大回撤：最痛时能亏到什么程度？

### 4.3 Python 实现示例

```python
import pandas as pd

def trade_stats(trade_returns: pd.Series) -> dict:
    """根据每笔交易收益率，统计胜率和盈亏比等指标。

    参数：
        trade_returns: 每笔交易的收益率，如 0.1 表示这一笔赚 10%。

    返回：
        包含以下键的字典：
        - win_rate: 胜率（0~1 之间）。
        - payoff_ratio: 盈亏比（平均盈利 / 平均亏损的绝对值）。
        - avg_win: 平均盈利收益率。
        - avg_loss: 平均亏损收益率（为负数）。
    """
    wins = trade_returns[trade_returns > 0]
    losses = trade_returns[trade_returns < 0]

    total_trades = len(trade_returns)
    win_trades = len(wins)

    if total_trades == 0:
        return {"win_rate": 0.0, "payoff_ratio": 0.0, "avg_win": 0.0, "avg_loss": 0.0}

    win_rate = win_trades / total_trades

    avg_win = wins.mean() if len(wins) > 0 else 0.0
    avg_loss = losses.mean() if len(losses) > 0 else 0.0

    if avg_loss == 0:
        payoff_ratio = 0.0
    else:
        payoff_ratio = avg_win / abs(avg_loss)

    return {
        "win_rate": float(win_rate),
        "payoff_ratio": float(payoff_ratio),
        "avg_win": float(avg_win),
        "avg_loss": float(avg_loss),
    }
```

你可以自己构造一个 Series 来测试，比如：

```python
trades = pd.Series([0.1, -0.03, 0.05, -0.02, -0.04, 0.08])
stats = trade_stats(trades)
```

然后对照手算结果理解每个数字的含义。

---

## 5. 小结与自我检验

### 5.1 今日关键记忆点

- **最大回撤**：
  - 看的是「从历史最高点跌到后面最低点」的最大跌幅比例。
  - 反映策略历史上最痛的一次亏损有多严重。
- **夏普比率**：
  - 收益 / 风险 的比值，风险用波动率来衡量。
  - 常用年化夏普来比较不同策略的「性价比」。
- **胜率与盈亏比**：
  - 胜率看赚钱的概率，盈亏比看赚一笔 vs 亏一笔的大小对比。
  - 胜率低但盈亏比高，依然能赚钱；反之亦然。

### 5.2 自测问题（建议口述或写在纸上）

1. 用自己的话解释「最大回撤」，尽量不用公式。
2. 为什么同样回报下，夏普比率高的策略更受欢迎？
3. 举一个「胜率不高但盈亏比很高」的例子。
4. 如果一个策略：
   - 胜率 80%，
   - 但偶尔会亏掉 30% 的净值，
   你觉得它的最大回撤可能会是什么量级？你敢全仓上吗？

### 5.3 下一步建议

- 在 `src/stage0` 新建一个练习脚本或 notebook：
  - 随机生成一段收益率序列，计算最大回撤和夏普比率。
  - 自己构造几组「每笔交易收益」，对比不同胜率/盈亏比的组合。
- 尝试把这些函数集成进你后面要写的「股票收益模拟器」中，让项目从一开始就具备风险分析能力。

---

以上就是 Day 12 的系统学习笔记，你可以在此基础上补充自己的理解和例子，让它慢慢变成你的「量化风险指标小手册」。