## Day 11 - 时间序列基础 & 移动平均

> 目标：
> - 用“数学 0 基础”的语言理解什么是时间序列
> - 建立对趋势、季节性、随机性的直观认识
> - 建立对“平稳性”的直觉，知道为什么价格和收益率要区别对待
> - 通过代码实践掌握简单移动平均（SMA）和指数加权移动平均（EMA）

对应代码文件：`src/stage0/day11_time_series_moving_average_demo.py`

---

### 一、什么是时间序列？

#### 1.1 数学思想（口语版）

- 普通数据（例如一堆人的身高）：打乱顺序，整体统计结果（均值、中位数等）基本不变。
- **时间序列**：是**按时间顺序排好的一串观测值**，顺序不能乱，因为“前后会互相影响”。

用交易的例子：

- BTC 每天的收盘价：`P_1, P_2, ..., P_t`
- BTC 每天的收益率：`r_1, r_2, ..., r_t`

这两条都是时间序列，只是度量的不一样（一个是价格，一个是收益）。

#### 1.2 直观理解

- 可以把时间序列想象成一条随时间变化的曲线：x 轴是时间，y 轴是价格或收益。
- K 线图、本项目中的价格折线图，都是时间序列的可视化形式。

#### 1.3 对量化交易的意义

- 量化交易几乎所有分析对象都是时间序列：价格、成交量、收益率、波动率……
- 我真正关心的不是“某一天的价格”，而是 **“价格是怎么走到这里的”**。 
- 很多模型都在回答：
  - “在过去的走势下，明天可能长什么样？”
  - “现在的波动和过去相比有没有明显变化？”

> 结论：时间序列 = 市场行为的轨迹，是量化建模的原材料。

---

### 二、趋势、季节性、随机性：把图拆成三层

可以把一条时间序列粗略拆成三部分：

> 时间序列 ≈ 趋势（Trend） + 季节性（Seasonality） + 随机波动（Noise）

#### 2.1 趋势（Trend）

- **直观**：
  - 长期往上：牛市
  - 长期往下：熊市
  - 长期横着：震荡市
- 图上看：如果把短期的抖动“抹平”，那条慢慢向上/向下的线，就是趋势。

- **交易意义**：
  - 趋势交易策略：顺着大方向做（涨就买、跌就空）。
  - 风险点：趋势会拐头，策略可能滞后反应。

#### 2.2 季节性（Seasonality）

- **直观**：
  - 某种模式会**周期性重复**。
  - 传统市场例子：
    - 星期一效应、月末效应等。
  - 加密市场：7x24 小时交易，更常见的是“日内季节性”，比如：某些时间段波动更大、成交量更集中。

- **交易意义**：
  - 如果能发现稳定的季节性规律，可以构造“时间相关因子”（如特定时间段的超额收益）。
  - 但要注意：规律随时间也可能失效（制度变化、参与者变化等）。

#### 2.3 随机性（Noise / 噪音）

- **直观**：
  - 价格在趋势线附近上下乱跳的部分，就是噪音。
  - 看 1 分钟线的时候，会觉得价格“乱蹦”，这部分随机性更明显。

- **交易意义**：
  - 噪音越大，短期越难预测，容易被“假突破”“假信号”骗。
  - 很多指标（例如移动平均线）就是在做一件事：**削弱噪音，让趋势更清晰**。

---

### 三、平稳性的直觉：价格 vs 收益率

#### 3.1 数学思想（口语版）

平稳性的大致意思：

- 这条时间序列的“游戏规则”大致稳定，不会随时间大幅变。
- 更具体地说：
  - 均值大致在一个水平附近晃，不明显往上/往下漂移；
  - 波动的大小（方差）差不多；
  - 不同时刻之间的“相关结构”也差不多。

> 简单记忆：**平稳 = 统计特性相对稳定**。

#### 3.2 直观例子

- **不平稳的例子**：
  - 价格序列：例如 BTC 价格从 1 万涨到 10 万，平均水平明显上移，属于非平稳。

- **更接近平稳的例子**：
  - 日收益率序列：今天涨 1%，明天跌 0.5%，长期在一个区间内上下波动，没有明显“越涨越快”或“越跌越快”的趋势。

#### 3.3 对量化交易的意义

- 很多时间序列模型（如 ARMA / GARCH 等）默认数据是“相对平稳”的。
- 直接拿价格建模，经常不满足这个前提，会导致模型效果不稳、检验失真。
- 因此：
  - 量化里通常对“**收益率**”建模，而不是对“**价格**”建模；
  - 有时会对序列做差分、对数变换等操作，让它更接近平稳。

> 结论：在建模和回测时，分清楚“价格”和“收益率”非常重要，后者往往更适合作为模型输入。

---

### 四、移动平均（SMA / EMA）的思想与交易意义

Day11 的代码实践部分主要是理解和实现 **移动平均**：

```python
# 移动平均
df['SMA_5'] = df['close'].rolling(window=5).mean()
df['SMA_20'] = df['close'].rolling(window=20).mean()

# 指数加权移动平均
df['EMA_12'] = df['close'].ewm(span=12).mean()
```

下面用思想 + 直观 + 交易意义的方式总结。

#### 4.1 简单移动平均（SMA）

- **数学思想**：
  - `SMA_n` = 最近 n 天收盘价的算术平均。
  - 每一天对平均的贡献是一样的权重。

- **直观理解**：
  - 在原始价格曲线外，“再画一条更平滑的线”，抹掉短期的剧烈抖动。
  - 窗口越大（例如 20 日、60 日），线越平滑，但反应越慢。

- **交易意义**：
  - 短期均线（如 5 日）：更贴近当前价格，反应灵敏。
  - 中长期均线（如 20 日、60 日）：代表中长期趋势，更稳定。
  - 常见用法：
    - 短均线上穿长均线（金叉）：趋势可能转多。
    - 短均线下穿长均线（死叉）：趋势可能转空。

#### 4.2 指数加权移动平均（EMA）

- **数学思想**：
  - 也是一种平均，但**越新的数据权重越大**，越旧的权重越小，指数衰减。

- **直观理解**：
  - 相比 SMA，EMA 对最近的价格更敏感，走势更“贴脸”，但仍然比原始价格平滑。

- **交易意义**：
  - EMA 常用于技术指标（如 MACD）中，用来捕捉趋势变化。
  - 对“近期行情变化”反应更快，有利于更早发现趋势拐点，但也更容易受到噪音影响。

---

### 五、Day11 代码示例说明

对应文件：`src/stage0/day11_time_series_moving_average_demo.py`

#### 5.1 核心类：`TimeSeriesMovingAverageDemo`

- **职责**：
  - 生成模拟价格时间序列（带趋势 + 随机波动）；
  - 在价格上计算 SMA/EMA；
  - 将价格与均线画在同一张图上，直观展示“平滑”和“趋势”。

- 主要方法：
  - `generate_price_series(n_days: int) -> pd.DataFrame`
    - 构造一个有日期索引和 `close` 列的 DataFrame。
    - 用“价格 = 起始价 × (1 + 日收益率) 的累乘”的方式模拟行情。
  - `add_moving_averages(df: pd.DataFrame) -> pd.DataFrame`
    - 在 `df` 上新增 `SMA_5`, `SMA_20`, `EMA_12` 三列。
  - `plot_price_and_averages(df: pd.DataFrame) -> None`
    - 画出：原始收盘价 + 3 条均线，帮助你在图上理解“趋势 vs 噪音”。
  - `run_demo() -> None`
    - 串联整个流程：生成数据 → 计算均线 → 绘制图形。

#### 5.2 如何在本地运行

在项目根目录下（已安装好 `requirements.txt`）运行：

```bash
python src/stage0/day11_time_series_moving_average_demo.py
```

看到的图像中：

- 黑色曲线：模拟收盘价 `close`；
- 蓝色曲线：5 日简单均线 `SMA_5`；
- 橙色曲线：20 日简单均线 `SMA_20`；
- 绿色曲线：12 日指数均线 `EMA_12`。

> 建议：先只看价格，再 mentally 想象“如果把小抖动抹平会怎样”，然后再对比均线曲线，强化直觉。

---

### 六、练习建议

#### 6.1 必做练习

- **练习 1：修改模拟参数**
  - 调整日收益率的均值（`loc`）和标准差（`scale`），观察价格和均线形状如何变化。
  - 思考：
    - 均值变大 → 长期趋势如何变化？
    - 标准差变大 → 噪音大小如何变化？均线还能看清趋势吗？

- **练习 2：调整均线窗口**
  - 改成 `SMA_10`, `SMA_50`, `EMA_26` 等不同组合。
  - 思考：
    - 窗口越大，均线越平滑，反应越慢；
    - 短均线和长均线之间的“交叉”，在图上意味着什么？

#### 6.2 进阶练习

- **练习 3：价格 vs 收益率的平稳性**
  - 在生成的价格数据上计算日收益率：
    - `df['return'] = df['close'].pct_change()`
  - 分别画出：价格曲线、收益率曲线；
  - 直观感受：哪一条更像“围绕某个水平上下波动”？

- **练习 4：真实数据替换模拟数据**（可等到后面学完数据获取再回头做）
  - 用真实 BTC 或其他币种的历史数据替换模拟数据；
  - 在真实数据上计算 SMA / EMA，并画图观察。

---

### 七、小结

1. **时间序列**：
   - 是按时间顺序排好的数据，顺序很重要；
   - 在量化交易中，价格、收益率、成交量等都是时间序列。

2. **趋势 / 季节性 / 随机性**：
   - 趋势：长期向上/向下/横盘的大方向；
   - 季节性：会周期性重复出现的模式；
   - 随机性：围绕趋势的小幅抖动，是噪音部分。

3. **平稳性直觉**：
   - 价格通常非平稳；
   - 收益率更接近平稳，更适合建模；
   - 建模前要先想一想：我用的是价格还是收益率？

4. **移动平均（SMA / EMA）**：
   - 通过“平均”来平滑序列、弱化噪音；
   - 短均线更敏感，长均线更稳定；
   - 在交易中常用来刻画趋势、构造交易信号（如金叉/死叉）。

Day11 的重点不是背公式，而是：

> 看得懂一条时间序列图，并能用“趋势 + 季节性 + 随机性 + 平稳性 + 均线”这些词，把图说清楚。

后面在做更复杂的 BTC 数据分析和回测时，这些直觉会被反复使用和加深。