## Day 9 - 相关性（协方差 & 相关系数）

### 1. 今日学习目标

- **理解协方差（covariance）**：两个变量是如何“一起动”的
- **理解相关系数（correlation, -1 ~ 1）**：协方差的标准化版本，方便不同数据之间比较
- **直觉区分**：正相关、负相关、不相关各是什么感觉
- **知道对交易的意义**：为什么分散投资要找“低相关甚至负相关”的资产
- **用代码体会**：通过 `correlation_example()` 和自己的练习，看到“图像形状 ↔ 相关系数数值”的对应关系

> 建议顺序：
> 1）先看“数学思想”抓整体；
> 2）再看“直观理解 + 交易意义”；
> 3）最后边看代码边做练习。

---

### 2. 数学思想：相关性在回答什么问题？

从“数学思想”上，相关性其实就回答一个问题：

> **当变量 A 在变化时，变量 B 有没有“倾向于”跟着一起变？方向是不是一致？这种关系有多强？**

我们用两个简单的随机变量来想象：

- `X`：BTC 的日收益率
- `Y`：ETH 的日收益率

每天我们看：今天的收益率，相对于“自己平时的平均水平”来说，是高一点，还是低一点：

- `X - E[X]` ：今天 BTC 比自己的“常态”高多少 / 低多少
- `Y - E[Y]` ：今天 ETH 比自己的“常态”高多少 / 低多少

#### 2.1 协方差：看它们是不是经常“同涨同跌”

协方差做的事，可以理解为：

> **把每一天 X、Y 对自己平均值的偏离量乘在一起，然后取平均。**

具体直觉：

- 如果大多数时候：
  - `X - E[X]` 和 `Y - E[Y]` **同号**（要么都 > 0，要么都 < 0）
  - 说明：当 BTC 比平时好时，ETH 通常也比平时好；当 BTC 比平时差时，ETH 通常也差
  - 这时候，两者有“同涨同跌”的倾向
  - 对应：**协方差 > 0 → 正相关趋势**

- 如果大多数时候：
  - 一个是正的，另一个是负的
  - 说明：一个比平时好时，另一个反而比平时差
  - 有点像“跷跷板”：一头上去，另一头下去
  - 对应：**协方差 < 0 → 负相关趋势**

- 如果：
  - 有时候同号，有时候异号，正负差不多
  - 那乘积有时正、有时负，平均后就接近 0
  - 对应：**协方差 ≈ 0 → 从线性角度看，基本不相关**

所以，协方差回答的是：

- **大于 0**：偏向于一起涨、一起跌 → 正相关
- **小于 0**：偏向于一涨一跌 → 负相关
- **接近 0**：线性关系上看不出明显涨跌同步 → 不相关

> 对你这种“数学基础较弱但有工程经验”的背景，可以把协方差理解为：
> **“每天的偏离量乘一下，然后平均，看看这两货是不是经常站在同一边。”**

#### 2.2 相关系数：把协方差标准化到 [-1, 1]

协方差有个麻烦：

- 它的大小会受到单位影响（收益率用 0.01 还是 1 表示，都会改变协方差数值）
- 直接看协方差很难比较不同资产、不同数据集的“相关强度”

解决办法：

> **相关系数 = 协方差 / (X 的标准差 × Y 的标准差)**

这样做之后：

- 相关系数变成一个**无单位的纯数**
- 且范围一定在 **[-1, 1]** 之间：
  - **1**：完全正相关（所有点都在一条从左下到右上的直线上）
  - **-1**：完全负相关（所有点都在一条从左上到右下的直线上）
  - **0**：线性上几乎没关系，看不出明显的直线趋势

**在实战中，你可以这样粗略理解绝对值的大小：**

- `0.0 ~ 0.3`：相关性很弱（基本看不出来）
- `0.3 ~ 0.7`：相关性中等（有明显趋势，但不完美）
- `0.7 ~ 1.0`：相关性很强（走势高度联动）

---

### 3. 直观理解：用生活 & 投资场景“脑补画面”

#### 3.1 正相关：一起涨一起跌

- 生活类比：
  - X：气温
  - Y：冰淇淋销量
  - 越热，卖得越多；越冷，卖得越少 → 明显正相关

- 投资类比：
  - X：BTC 收益
  - Y：大部分主流山寨币收益
  - 牛市情绪好时一起涨，大跌时一起跌 → **高正相关** 很常见

**散点图直觉**：

- 把每一天的 (X, Y) 画成一个点
- 如果大致沿着一条**从左下往右上**的斜线排布 → 正相关
- 这条“带子”越细，点越贴近一条线 → 相关越强

#### 3.2 负相关：一涨一跌的“跷跷板”

- 投资类比：
  - X：风险资产（比如股市、部分高 Beta 币）
  - Y：避险资产（某些债券、黄金类资产）
  - 市场恐慌：X 跌、Y 涨
  - 市场亢奋：X 涨、Y 可能跌或不动
  - 两者就形成类似“跷跷板” → 负相关

**散点图直觉**：

- 点云沿着**从左上往右下**的斜线排布

#### 3.3 不相关：各玩各的，互相不搭理

- 生活类比：
  - X：你的身高
  - Y：你今天 BTC 是赚还是亏
  - 基本没关系 → 不相关

**散点图直觉**：

- 点看起来像一团“云”，没有明显往左上或右上倾斜的线

---

### 4. 对交易的意义：为什么要找低相关 / 负相关资产？

从交易 & 风险管理角度，相关性直接对应到**分散风险**：

- 如果你持有的资产：
  - 彼此高度正相关
  - 那么市场好时是一起赚，但市场差时会一起亏
  - 组合整体的波动和回撤会非常大

- 如果你能搭配一些**低相关甚至负相关**的资产：
  - A 跌的时候，B 可能没什么动，甚至略涨
  - 组合整体的盈亏会“平均”一些
  - **期望收益不一定更高，但整体曲线更平滑，最大回撤更小**

换一种直观点的说法：

> **相关性，就是在帮你判断：
>  这些资产是一起沉船，还是有人能在别人跌的时候帮你“托一把”？**

这也是“分散投资”的数学基础之一：

- 不要只看单个标的的收益和波动
- 还要看它“放进组合里”和别人一块儿是什么关系

---

### 5. 代码讲解：`correlation_example()` 在干什么？

在 `阶段0-数学预热代码示例.py` 里，`correlation_example()` 这段代码的核心流程是：

1. **模拟数据**：
   - 生成 100 天的 BTC 日收益率 `btc_returns`
   - 生成 ETH 日收益率 `eth_returns`：
     - 大致是 `0.8 * btc_returns + 一些正态噪声`
     - 相当于“ETH 主要跟着 BTC 走，但有自己的一些随机波动”

2. **计算相关系数**：
   - `correlation = np.corrcoef(btc_returns, eth_returns)[0, 1]`
   - 这是 NumPy 内置的相关系数计算函数
   - 输出时根据绝对值判断“强 / 中 / 弱 正/负相关”

3. **可视化 1：散点图**：
   - x 轴：BTC 日收益率
   - y 轴：ETH 日收益率
   - 每个点是一日 (BTC, ETH)
   - 再画一条拟合直线，看点是否基本沿着一条“向上斜线” → 正相关

4. **可视化 2：时间序列对比**：
   - 在同一张图上画出两条曲线：BTC 收益序列 & ETH 收益序列
   - 如果大多数时候两条线方向一致（同时向上或向下），肉眼也能看出“联动性”

> 使用建议：
> - 先只看打印出来的相关系数数值和散点图形状，尝试自己用口语描述：
>   - “点大概在一条向上斜线附近”
>   - “相关系数 0.xx，属于中等偏强的正相关”
> - 再回到代码，看它是如何通过 `0.8 * btc_returns + 噪声` 人为制造关联的。

---

### 6. 练习 1：生成两个完全正相关的序列

**数学思想**：

- “完全正相关”意味着：
  - 两个变量之间存在一个完美的线性关系：`Y = aX + b`
  - 没有额外噪声 → 所有点都在同一条直线上
  - 相关系数 = 1

**实现思路**：

1. 生成基础序列 `x`：
   - 例如：100 个正态随机数
2. 构造 `y = 3 * x + 1`
3. 调用 `np.corrcoef(x, y)[0, 1]` 计算相关系数
4. 画散点图，观察所有点是不是严格落在同一条直线上

**思考扩展**：

- 把 `y` 改成 `y = 3 * x + 1 + 小噪声`：
  - 噪声越大，散点越散，相关系数绝对值会从 1 慢慢下降

---

### 7. 练习 2：生成两个完全负相关的序列

**数学思想**：

- “完全负相关”意味着：
  - `Y = aX + b` 中的 `a < 0`
  - X 大时 Y 小，X 小时 Y 大
  - 所有点在一条从左上到右下的直线上
  - 相关系数 = -1

**实现思路**：

1. 同样先生成基础序列 `x`
2. 构造 `y = -2 * x + 1`
3. 计算相关系数 `np.corrcoef(x, y)[0, 1]`，应该非常接近 -1
4. 画散点图，你会看到点沿着一条“向下的直线”排布

**思考扩展**：

- 在 `y` 中加入噪声：`y = -2 * x + 1 + 噪声`
  - 噪声越大，点云越散，相关系数的绝对值从 1 往 0 靠近

---

### 8. 练习 3：生成两个不相关的序列

**数学思想**：

- “不相关”并不是说“完全没关系”，而是：
  - 从**线性关系**角度，看不出“X 大时 Y 也偏大 / 偏小”的明显趋势
  - 散点图没有明显的斜线结构
  - 相关系数接近 0

**实现思路**：

1. 生成两个独立的随机序列 `x` 和 `y`：
   - 例如：
   - `x = np.random.normal(0, 1, size=100)`
   - `y = np.random.normal(0, 1, size=100)`
2. 计算 `np.corrcoef(x, y)[0, 1]`
   - 一般会在 -0.2 ~ 0.2 之间晃动
3. 多跑几次你会发现：
   - 理论上它们应当“不相关”，但有限样本下相关系数很难刚好等于 0

**思考扩展**：

- 把样本数从 100 提升到 10_000，再观察相关系数：
  - 随着样本增加，相关系数会更稳定、更接近 0
  - 这和前面“大数定律”的直觉是相通的。

---

### 9. 小结：Day 9 需要真正掌握的点

- **数学思想**：
  - 协方差：看两个变量是否经常“一起高于平均”或“一起低于平均”
  - 相关系数：对协方差做标准化，统一到 [-1, 1] 方便比较

- **直观图像**：
  - 正相关：散点图从左下到右上
  - 负相关：散点图从左上到右下
  - 不相关：一团云，没有明显斜线

- **对交易的意义**：
  - 高度正相关的资产放一起，组合涨跌都很猛
  - 低相关/负相关资产搭配，有助于降低组合总体波动和回撤

- **代码技能**：
  - 使用 `np.corrcoef` 计算相关系数
  - 用散点图 + 时间序列图，肉眼观察相关性
  - 能通过构造数据，刻意生成“强正相关、强负相关、不相关”的例子

把这些点想明白、写出来，你就已经用“开发者的方式”真正理解了 Day 9 的相关性，而不是只记一个公式。